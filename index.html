<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StackTrack â€” Bullion Broker Platform</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CSS VARIABLES & THEMES                 */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --gold: #C9A84C;
  --gold-dim: #A8893A;
  --silver: #A8A8A8;
  --silver-dim: #888888;
  --green: #4CAF50;
  --red: #E53935;
  --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
  --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --radius: 8px;
  --transition: 0.2s ease;
}

[data-theme="dark"] {
  --bg-primary: #0a0a0a;
  --bg-secondary: #141414;
  --bg-card: #1a1a1a;
  --bg-input: #111111;
  --border: #2a2a2a;
  --border-focus: var(--gold);
  --text-primary: #e8e8e8;
  --text-secondary: #999999;
  --text-muted: #666666;
  --header-bg: #0d0d0d;
  --nav-bg: #111111;
  --nav-active: var(--gold);
  --nav-hover: #1e1e1e;
  --btn-primary-bg: var(--gold);
  --btn-primary-text: #0a0a0a;
  --btn-secondary-bg: #222222;
  --btn-secondary-text: #ccc;
  --alert-bg: #2a1010;
  --alert-border: var(--red);
}

[data-theme="light"] {
  --bg-primary: #f5f5f5;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-input: #f9f9f9;
  --border: #e0e0e0;
  --border-focus: var(--gold);
  --text-primary: #1a1a1a;
  --text-secondary: #555555;
  --text-muted: #999999;
  --header-bg: #ffffff;
  --nav-bg: #fafafa;
  --nav-active: var(--gold);
  --nav-hover: #f0f0f0;
  --btn-primary-bg: var(--gold);
  --btn-primary-text: #ffffff;
  --btn-secondary-bg: #e8e8e8;
  --btn-secondary-text: #333;
  --alert-bg: #fff0f0;
  --alert-border: var(--red);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* RESET & BASE                           */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  transition: background var(--transition), color var(--transition);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* HEADER                                 */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header {
  background: var(--header-bg);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 1px;
}

.logo span:first-child { color: var(--gold); }
.logo span:last-child { color: var(--text-secondary); }

.shop-name {
  font-size: 13px;
  color: var(--text-muted);
  border-left: 1px solid var(--border);
  padding-left: 16px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 24px;
}

.spot-prices {
  display: flex;
  gap: 20px;
  align-items: center;
}

.spot-price-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.spot-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.spot-label.gold { color: var(--gold); }
.spot-label.silver { color: var(--silver); }

.spot-value {
  font-family: var(--mono);
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
}

.spot-change {
  font-family: var(--mono);
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
}

.spot-change.up { color: var(--green); background: rgba(76, 175, 80, 0.1); }
.spot-change.down { color: var(--red); background: rgba(229, 57, 53, 0.1); }

.spot-updated {
  font-size: 10px;
  color: var(--text-muted);
  font-family: var(--mono);
}

.spot-warning {
  font-size: 10px;
  color: var(--red);
  display: none;
}

/* Theme toggle */
.theme-toggle {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 16px;
  width: 56px;
  height: 28px;
  position: relative;
}

.theme-toggle .toggle-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--gold);
  position: absolute;
  transition: transform var(--transition);
  transform: translateX(0);
}

[data-theme="light"] .theme-toggle .toggle-thumb {
  transform: translateX(28px);
}

.theme-toggle .icon {
  width: 20px;
  text-align: center;
  font-size: 12px;
  z-index: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* NAVIGATION                             */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.nav {
  background: var(--nav-bg);
  border-bottom: 1px solid var(--border);
  display: flex;
  padding: 0 24px;
}

.nav-item {
  padding: 12px 20px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  user-select: none;
}

.nav-item:hover {
  color: var(--text-primary);
  background: var(--nav-hover);
}

.nav-item.active {
  color: var(--nav-active);
  border-bottom-color: var(--nav-active);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* MAIN CONTENT                           */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
}

.page { display: none; }
.page.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* INVENTORY ALERT BANNER                 */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.alert-banner {
  background: var(--alert-bg);
  border: 1px solid var(--alert-border);
  border-radius: var(--radius);
  padding: 12px 20px;
  margin-bottom: 20px;
  display: none;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  color: var(--red);
  font-size: 14px;
}

.alert-banner.visible { display: flex; }
.alert-banner .alert-icon { font-size: 18px; }
#bulkFlagBtn { background: var(--red); color: #fff; border: none; border-radius: var(--radius); padding: 4px 12px; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CARDS                                  */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
}

.card-title {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* DEAL CALCULATOR                        */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calc-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.calc-inputs .form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-secondary);
}

.form-select, .form-input {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  font-size: 14px;
  color: var(--text-primary);
  font-family: var(--sans);
  transition: border-color var(--transition);
  outline: none;
  width: 100%;
}

.form-select:focus, .form-input:focus {
  border-color: var(--border-focus);
}

.form-input[type="number"] {
  font-family: var(--mono);
}

/* Segment control for transaction type */
.segment-control {
  display: flex;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
}

.segment-btn {
  flex: 1;
  padding: 10px 8px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  transition: all var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.segment-btn:hover {
  color: var(--text-primary);
  background: var(--nav-hover);
}

.segment-btn.active {
  background: var(--gold);
  color: #0a0a0a;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CALCULATOR OUTPUT                      */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calc-output {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.output-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}

.output-row:last-child { border-bottom: none; }

.output-label {
  font-size: 13px;
  color: var(--text-secondary);
}

.output-value {
  font-family: var(--mono);
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
}

.output-value.gold { color: var(--gold); }
.output-value.green { color: var(--green); }
.output-value.large {
  font-size: 28px;
}

.output-value.profit-highlight {
  color: var(--green);
  font-size: 24px;
}

.log-deal-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 6px;
  background: var(--gold);
  color: #0a0a0a;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: opacity var(--transition);
  margin-top: 8px;
}

.log-deal-btn:hover { opacity: 0.85; }
.log-deal-btn:active { opacity: 0.7; }

.log-deal-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.deal-logged-msg {
  text-align: center;
  color: var(--green);
  font-weight: 600;
  font-size: 13px;
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.3s;
}

.deal-logged-msg.show { opacity: 1; }

.deal-action-buttons {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.add-line-btn {
  flex: 1;
  padding: 14px;
  border: 2px dashed var(--gold);
  border-radius: 6px;
  background: transparent;
  color: var(--gold);
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: opacity var(--transition), background var(--transition);
}

.add-line-btn:hover { background: rgba(201,168,76,0.08); }
.add-line-btn:disabled { opacity: 0.4; cursor: not-allowed; background: transparent; }

.deal-lines-container {
  margin-top: 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  overflow: hidden;
}

.deal-lines-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-input);
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
}

.deal-lines-count {
  background: var(--gold);
  color: #0a0a0a;
  font-size: 11px;
  font-weight: 700;
  padding: 1px 7px;
  border-radius: 10px;
  margin-left: 6px;
}

.deal-line-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.deal-line-item:last-child { border-bottom: none; }

.deal-line-desc {
  flex: 1;
  color: var(--text-primary);
}

.deal-line-total {
  font-family: var(--mono);
  font-weight: 600;
  color: var(--text-primary);
  margin: 0 12px;
}

.deal-line-remove {
  background: none;
  border: none;
  color: var(--red);
  cursor: pointer;
  font-size: 14px;
  padding: 2px 6px;
  border-radius: 4px;
  transition: background var(--transition);
}

.deal-line-remove:hover { background: rgba(229,57,53,0.1); }

.deal-lines-totals {
  display: flex;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg-input);
  border-top: 1px solid var(--border);
  font-size: 13px;
  font-weight: 700;
}

.deal-lines-totals .total-label { color: var(--text-secondary); }
.deal-lines-totals .total-value { font-family: var(--mono); color: var(--text-primary); }
.deal-lines-totals .profit-value { font-family: var(--mono); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* TRANSACTION LOG                        */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filters-bar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 16px;
  align-items: flex-end;
}

.filters-bar .form-group { min-width: 140px; }

.filter-btn, .export-btn {
  padding: 10px 16px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--btn-secondary-bg);
  color: var(--btn-secondary-text);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all var(--transition);
  white-space: nowrap;
  align-self: flex-end;
}

.export-btn {
  background: var(--gold);
  color: #0a0a0a;
  border-color: var(--gold);
}

.filter-btn:hover, .export-btn:hover { opacity: 0.85; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th {
  text-align: left;
  padding: 10px 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  border-bottom: 2px solid var(--border);
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
}

th:hover { color: var(--text-secondary); }
th .sort-arrow { font-size: 10px; margin-left: 4px; }

td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

td.mono {
  font-family: var(--mono);
}

td.profit-positive { color: var(--green); font-family: var(--mono); }
td.profit-negative { color: var(--red); font-family: var(--mono); }

.type-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.type-badge.buy { background: rgba(76, 175, 80, 0.15); color: var(--green); }
.type-badge.sell { background: rgba(201, 168, 76, 0.15); color: var(--gold); }
.type-badge.wholesale { background: rgba(168, 168, 168, 0.15); color: var(--silver); }

.row-actions {
  display: flex;
  gap: 8px;
}

.row-action-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  padding: 2px 4px;
  opacity: 0.5;
  transition: opacity var(--transition);
}

.row-action-btn:hover { opacity: 1; }

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
  font-size: 14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* INVENTORY                              */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inventory-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 24px;
}

.inventory-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
}

.inventory-card.gold-card { border-top: 3px solid var(--gold); }
.inventory-card.silver-card { border-top: 3px solid var(--silver); }

.inventory-metal-label {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.inventory-metal-label.gold { color: var(--gold); }
.inventory-metal-label.silver { color: var(--silver); }

.inventory-oz {
  font-family: var(--mono);
  font-size: 36px;
  font-weight: 700;
  color: var(--text-primary);
}

.inventory-oz-label {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

.inventory-value {
  font-family: var(--mono);
  font-size: 16px;
  color: var(--text-secondary);
  margin-top: 8px;
}

.inventory-breakdown {
  margin-top: 16px;
  text-align: left;
  font-size: 12px;
}

.breakdown-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  color: var(--text-secondary);
}

.breakdown-row .breakdown-val {
  font-family: var(--mono);
  color: var(--text-primary);
}
.breakdown-row.low-stock .breakdown-val {
  color: var(--red);
}
.reorder-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--red);
  margin-right: 6px;
  vertical-align: middle;
}
.reorder-alert-item {
  display: flex;
  align-items: center;
  padding: 6px 0;
  font-size: 13px;
  color: var(--red);
  border-bottom: 1px solid var(--border);
}
.reorder-alert-item:last-child {
  border-bottom: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* WHOLESALE CONTACTS                     */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.contacts-list {
  display: grid;
  gap: 8px;
}

.contact-row {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg-input);
}

.contact-name { font-weight: 600; flex: 1; }
.contact-company { color: var(--text-secondary); font-size: 13px; flex: 1; }
.contact-phone { font-family: var(--mono); font-size: 13px; color: var(--text-muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CUSTOMER SELECTOR                      */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.customer-selector-wrapper {
  position: relative;
}

.customer-input {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 32px 10px 12px;
  font-size: 14px;
  color: var(--text-primary);
  font-family: var(--sans);
  transition: border-color var(--transition);
  outline: none;
  width: 100%;
}

.customer-input:focus { border-color: var(--border-focus); }

.customer-input.has-selection {
  border-color: var(--gold);
  font-weight: 600;
}

.customer-clear-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 16px;
  cursor: pointer;
  padding: 2px 4px;
  line-height: 1;
  display: none;
}

.customer-clear-btn.visible { display: block; }
.customer-clear-btn:hover { color: var(--text-primary); }

.customer-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 0 0 6px 6px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 50;
  display: none;
}

.customer-dropdown.open { display: block; }

.customer-dropdown-item {
  padding: 8px 12px;
  cursor: pointer;
  transition: background var(--transition);
  border-bottom: 1px solid var(--border);
}

.customer-dropdown-item:last-child { border-bottom: none; }
.customer-dropdown-item:hover { background: var(--nav-hover); }

.customer-dropdown-item.add-new {
  color: var(--gold);
  font-weight: 600;
}

.customer-item-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.customer-item-details {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* P&L DASHBOARD                          */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pnl-period-selector {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
}

.period-btn {
  padding: 8px 20px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--btn-secondary-bg);
  color: var(--btn-secondary-text);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: all var(--transition);
}

.period-btn.active {
  background: var(--gold);
  color: #0a0a0a;
  border-color: var(--gold);
}

.pnl-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}

.pnl-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
}

.pnl-card-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.pnl-card-value {
  font-family: var(--mono);
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
}

.pnl-card-value.green { color: var(--green); }
.pnl-card-value.gold { color: var(--gold); }

.pnl-card-sub {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* SETTINGS                               */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-section {
  margin-bottom: 32px;
}

.settings-section-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text-primary);
}

.settings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
}

.settings-grid .form-group label {
  font-size: 12px;
}

.settings-save-btn {
  padding: 12px 32px;
  border: none;
  border-radius: 6px;
  background: var(--gold);
  color: #0a0a0a;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: opacity var(--transition);
  margin-top: 12px;
}

.settings-save-btn:hover { opacity: 0.85; }

.save-confirm {
  display: inline-block;
  margin-left: 12px;
  color: var(--green);
  font-weight: 600;
  font-size: 13px;
  opacity: 0;
  transition: opacity 0.3s;
}

.save-confirm.show { opacity: 1; }

.data-mgmt-actions {
  display: flex;
  gap: 10px;
  margin-top: 4px;
}

.data-mgmt-actions button {
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: opacity var(--transition);
}

.data-export-btn {
  border: none;
  background: var(--gold);
  color: #0a0a0a;
}

.data-import-btn {
  border: 1px solid var(--border);
  background: var(--btn-secondary-bg);
  color: var(--btn-secondary-text);
}

.data-mgmt-actions button:hover { opacity: 0.85; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* MODAL                                  */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  width: 100%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
}

.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}

.modal-btn {
  padding: 10px 20px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
}

.modal-btn.primary {
  background: var(--gold);
  color: #0a0a0a;
  border-color: var(--gold);
}

.modal-btn.secondary {
  background: var(--btn-secondary-bg);
  color: var(--btn-secondary-text);
}

.modal-btn.danger {
  background: var(--red);
  color: white;
  border-color: var(--red);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* RECEIPT                                */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.receipt-content {
  font-family: var(--mono);
  font-size: 13px;
  color: #111;
  background: #fff;
  padding: 32px;
  border-radius: var(--radius);
  max-width: 400px;
  margin: 0 auto;
}

.receipt-content .receipt-header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px dashed #ccc;
}

.receipt-content .receipt-shop-name {
  font-size: 18px;
  font-weight: 700;
  color: #111;
  margin-bottom: 4px;
}

.receipt-content .receipt-subtitle {
  font-size: 11px;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.receipt-content .receipt-date {
  font-size: 12px;
  color: #666;
  margin-top: 8px;
}

.receipt-content .receipt-body {
  margin-bottom: 20px;
}

.receipt-content .receipt-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px dotted #ddd;
}

.receipt-content .receipt-row:last-child { border-bottom: none; }

.receipt-content .receipt-label {
  color: #666;
  font-size: 12px;
}

.receipt-content .receipt-val {
  font-weight: 700;
  color: #111;
  font-size: 13px;
}

.receipt-content .receipt-total {
  text-align: center;
  margin: 20px 0;
  padding: 16px 0;
  border-top: 2px dashed #ccc;
  border-bottom: 2px dashed #ccc;
}

.receipt-content .receipt-total-label {
  font-size: 11px;
  color: #888;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.receipt-content .receipt-total-value {
  font-size: 28px;
  font-weight: 700;
  color: #111;
  margin-top: 4px;
}

.receipt-content .receipt-footer {
  text-align: center;
  font-size: 11px;
  color: #aaa;
  margin-top: 16px;
}

.receipt-actions {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 16px;
}

@media print {
  body * { visibility: hidden; }
  .receipt-content, .receipt-content * { visibility: visible; }
  .receipt-content {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    padding: 20px;
    box-shadow: none;
  }
  .modal-overlay, .modal, .receipt-actions { display: none !important; }
  .receipt-content { display: block !important; visibility: visible !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* COMPLIANCE (FORM 8300)                 */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.compliance-badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: rgba(229, 57, 53, 0.15);
  color: var(--red);
  margin-left: 6px;
  vertical-align: middle;
}

.compliance-warning {
  background: rgba(255, 179, 0, 0.1);
  border: 1px solid #FFB300;
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 600;
  color: #FFB300;
  display: none;
  gap: 8px;
  align-items: flex-start;
  line-height: 1.4;
}

.compliance-warning.visible { display: flex; }

.compliance-warning .compliance-icon { font-size: 16px; flex-shrink: 0; }

.compliance-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--red);
  margin-left: 6px;
  vertical-align: middle;
}

tr.compliance-row-flagged {
  border-left: 3px solid var(--red);
  background: rgba(229, 57, 53, 0.04);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* COMPLIANCE (1099-B)                     */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.compliance-badge-1099b {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: rgba(255, 152, 0, 0.15);
  color: #FF9800;
  margin-left: 6px;
  vertical-align: middle;
}

tr.compliance-row-1099b {
  border-left: 3px solid #FF9800;
  background: rgba(255, 152, 0, 0.04);
}

/* When both 8300 and 1099-B, red border takes priority */
tr.compliance-row-flagged.compliance-row-1099b {
  border-left: 3px solid var(--red);
}

.compliance-warning-1099b {
  background: rgba(33, 150, 243, 0.1);
  border: 1px solid #2196F3;
  border-radius: 6px;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 600;
  color: #2196F3;
  display: none;
  gap: 8px;
  align-items: flex-start;
  line-height: 1.4;
  margin-top: 8px;
}

.compliance-warning-1099b.visible { display: flex; }

.compliance-warning-1099b .compliance-icon { font-size: 16px; flex-shrink: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CUSTOMER PROFILE MODAL                 */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.customer-profile-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: flex-start;
  justify-content: center;
  z-index: 200;
  padding-top: 40px;
  overflow-y: auto;
}

.customer-profile-overlay.open { display: flex; }

.customer-profile-modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  width: 100%;
  max-width: 900px;
  margin-bottom: 40px;
}

.cp-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.cp-header-left { flex: 1; min-width: 200px; }

.cp-header-left h2 {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.cp-fields {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.cp-fields .form-group { margin: 0; }

.cp-header-right {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  padding-top: 32px;
}

.cp-stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.cp-stat-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
}

.cp-stat-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.cp-stat-value {
  font-family: var(--mono);
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
}

.cp-stat-value.green { color: var(--green); }

.cp-compliance {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.cp-compliance-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.cp-compliance-item .count {
  font-family: var(--mono);
  font-weight: 700;
}

.cp-compliance-item.warn { color: var(--red); }
.cp-compliance-item.ok { color: var(--green); }
.cp-compliance-item.info { color: #FF9800; }

.cp-section-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 10px;
  color: var(--text-primary);
}

.cp-tx-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.cp-tx-table th {
  text-align: left;
  padding: 8px 10px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
}

.cp-tx-table td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text-secondary);
}

.cp-tx-table .mono { font-family: var(--mono); font-size: 12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* DASHBOARD                              */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dashboard-top-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}

.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
}

.kpi-card-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.kpi-card-value {
  font-family: var(--mono);
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
}

.kpi-card-value.green { color: var(--green); }
.kpi-card-value.red { color: var(--red); }
.kpi-card-value.gold { color: var(--gold); }

.dashboard-mid-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}

.dashboard-mid-grid .card { margin-bottom: 0; }

.dashboard-recent { margin-bottom: 20px; }

.compliance-action-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: background var(--transition);
}

.compliance-action-item:hover { background: var(--bg-secondary); }

.compliance-action-item:last-child { border-bottom: none; }

.compliance-action-item .action-label { font-weight: 600; }

.compliance-action-item .action-count {
  font-family: var(--mono);
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.compliance-action-item .action-count.red {
  background: rgba(229, 57, 53, 0.15);
  color: var(--red);
}

.compliance-action-item .action-count.orange {
  background: rgba(255, 152, 0, 0.15);
  color: #FF9800;
}

.compliance-action-item .action-count.green {
  background: rgba(76, 175, 80, 0.15);
  color: var(--green);
}

.inv-snapshot-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.inv-snapshot-row:last-child { border-bottom: none; }

.inv-snapshot-label { font-weight: 600; color: var(--text-primary); }
.inv-snapshot-oz { font-family: var(--mono); color: var(--text-secondary); }
.inv-snapshot-val { font-family: var(--mono); color: var(--text-muted); font-size: 12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* RESPONSIVE                             */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .header {
    flex-direction: column;
    gap: 12px;
    padding: 12px 16px;
  }
  .header-right { flex-wrap: wrap; justify-content: center; }
  .spot-prices { flex-wrap: wrap; justify-content: center; }
  .nav { overflow-x: auto; padding: 0 12px; }
  .nav-item { padding: 10px 14px; font-size: 12px; }
  .main { padding: 16px; }
  .calc-layout { grid-template-columns: 1fr; }
  .inventory-grid { grid-template-columns: 1fr; }
  .pnl-grid { grid-template-columns: 1fr; }
  .settings-grid { grid-template-columns: 1fr; }
  .filters-bar { flex-direction: column; }
  .dashboard-top-grid { grid-template-columns: 1fr 1fr; }
  .dashboard-mid-grid { grid-template-columns: 1fr; }
  .cp-stats-grid { grid-template-columns: 1fr 1fr; }
  .cp-fields { grid-template-columns: 1fr; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CUSTOMERS PAGE                         */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.customers-search-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  align-items: center;
}
.customers-search-bar input {
  flex: 1;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  color: var(--text-primary);
  font-size: 14px;
  font-family: var(--sans);
  outline: none;
  transition: border-color var(--transition);
}
.customers-search-bar input:focus {
  border-color: var(--gold);
}
.customers-search-bar button {
  background: var(--gold);
  color: #0a0a0a;
  border: none;
  border-radius: var(--radius);
  padding: 10px 20px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
  transition: opacity var(--transition);
}
.customers-search-bar button:hover { opacity: 0.85; }
.customers-table {
  width: 100%;
  border-collapse: collapse;
}
.customers-table th {
  text-align: left;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
}
.customers-table td {
  padding: 12px;
  font-size: 14px;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border);
}
.customer-row {
  cursor: pointer;
  transition: background var(--transition);
}
.customer-row:hover {
  background: var(--bg-secondary);
}
.w9-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.w9-badge.on-file {
  background: rgba(76, 175, 80, 0.15);
  color: var(--green);
}
.w9-badge.missing {
  background: rgba(255, 152, 0, 0.15);
  color: #FF9800;
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="header">
  <div class="header-left">
    <div class="logo"><span>STACK</span><span>TRACK</span></div>
    <div class="shop-name" id="shopNameDisplay">My Bullion Shop</div>
  </div>
  <div class="header-right">
    <div class="spot-prices">
      <div class="spot-price-item">
        <span class="spot-label gold">GOLD</span>
        <span class="spot-value" id="goldSpot">$2,345.60</span>
        <span class="spot-change up" id="goldChange">+0.42%</span>
      </div>
      <div class="spot-price-item">
        <span class="spot-label silver">SILVER</span>
        <span class="spot-value" id="silverSpot">$30.15</span>
        <span class="spot-change up" id="silverChange">+0.28%</span>
      </div>
      <div>
        <div class="spot-updated" id="spotUpdated">Updated just now</div>
        <div class="spot-warning" id="spotWarning">API unavailable â€” showing last known price</div>
      </div>
    </div>
    <div class="theme-toggle" id="themeToggle" title="Toggle theme">
      <span class="icon">ğŸŒ™</span>
      <span class="icon">â˜€ï¸</span>
      <div class="toggle-thumb"></div>
    </div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="nav">
  <div class="nav-item active" data-page="dashboard">Dashboard</div>
  <div class="nav-item" data-page="calculator">Calculator</div>
  <div class="nav-item" data-page="transactions">Transactions</div>
  <div class="nav-item" data-page="inventory">Inventory</div>
  <div class="nav-item" data-page="customers">Customers</div>
  <div class="nav-item" data-page="pnl">P&L</div>
  <div class="nav-item" data-page="settings">Settings</div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALERT BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">
  <div class="alert-banner" id="alertBanner">
    <span class="alert-icon">âš </span>
    <span id="alertText">Inventory threshold exceeded â€” consider wholesaling</span>
    <button id="bulkFlagBtn" style="display:none">Flag All</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page active" id="page-dashboard">
    <div class="dashboard-top-grid">
      <div class="kpi-card">
        <div class="kpi-card-label">Today's Transactions</div>
        <div class="kpi-card-value" id="dashTxCount">0</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-card-label">Today Bought ($)</div>
        <div class="kpi-card-value gold" id="dashBought">$0.00</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-card-label">Today Sold ($)</div>
        <div class="kpi-card-value" id="dashSold">$0.00</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-card-label">Today's Profit</div>
        <div class="kpi-card-value green" id="dashProfit">$0.00</div>
      </div>
    </div>

    <div class="dashboard-mid-grid">
      <div class="card">
        <div class="card-title">Inventory Snapshot</div>
        <div id="dashInventory">
          <div class="inv-snapshot-row">
            <span class="inv-snapshot-label" style="color:var(--gold)">Gold</span>
            <span class="inv-snapshot-oz" id="dashGoldOz">0.000 oz</span>
            <span class="inv-snapshot-val" id="dashGoldVal">$0.00</span>
          </div>
          <div class="inv-snapshot-row">
            <span class="inv-snapshot-label" style="color:var(--silver)">Silver</span>
            <span class="inv-snapshot-oz" id="dashSilverOz">0.000 oz</span>
            <span class="inv-snapshot-val" id="dashSilverVal">$0.00</span>
          </div>
          <div class="inv-snapshot-row">
            <span class="inv-snapshot-label">Junk Silver</span>
            <span class="inv-snapshot-oz" id="dashJunkOz">0.000 oz</span>
            <span class="inv-snapshot-val" id="dashJunkVal">$0.00</span>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Compliance Action Items</div>
        <div id="dashCompliance">
          <div class="compliance-action-item" onclick="navigateToCompliance('needs-review')">
            <span class="action-label">Unfiled Form 8300</span>
            <span class="action-count red" id="dashUnfiled8300">0</span>
          </div>
          <div class="compliance-action-item" onclick="navigateToCompliance('1099b-needs-filing')">
            <span class="action-label">Unfiled 1099-B</span>
            <span class="action-count orange" id="dashUnfiled1099B">0</span>
          </div>
          <div class="compliance-action-item" onclick="navigateToCompliance('w9-needed')">
            <span class="action-label">Customers Needing W-9</span>
            <span class="action-count orange" id="dashNeedW9">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="dashboard-recent">
      <div class="card">
        <div class="card-title">Recent Transactions</div>
        <div style="overflow-x: auto;">
          <table class="cp-tx-table" id="dashRecentTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Metal</th>
                <th>Type</th>
                <th>Customer</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody id="dashRecentBody"></tbody>
          </table>
        </div>
        <div class="empty-state" id="dashRecentEmpty" style="display:none;">No transactions yet.</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CALCULATOR PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="page-calculator">
    <div class="calc-layout">
      <div class="card calc-inputs">
        <div class="card-title">Deal Calculator</div>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Metal</label>
            <select class="form-select" id="calcMetal">
              <option value="gold">Gold</option>
              <option value="silver">Silver</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Form</label>
            <select class="form-select" id="calcForm">
              <option value="coins">Coins</option>
              <option value="bars">Bars</option>
              <option value="rounds">Rounds</option>
              <option value="junk">Junk Silver (90%)</option>
              <option value="scrap">Other Scrap</option>
            </select>
          </div>
          <div class="form-group" id="coinTypeGroup">
            <label class="form-label">Coin Type</label>
            <select class="form-select" id="calcCoinType">
              <option value="eagles">American Eagles</option>
              <option value="maples">Maple Leafs</option>
              <option value="krugerrands">Krugerrands</option>
              <option value="britannias">Britannias</option>
              <option value="philharmonics">Philharmonics</option>
              <option value="pre33_20">$20 Double Eagle</option>
              <option value="pre33_10">$10 Eagle</option>
              <option value="pre33_5">$5 Half Eagle</option>
              <option value="pre33_250">$2.50 Quarter Eagle</option>
            </select>
          </div>
          <div class="form-group" id="weightUnitGroup" style="display:none">
            <label class="form-label">Weight Unit</label>
            <select class="form-select" id="calcWeightUnit">
              <option value="ozt">Troy Oz</option>
              <option value="g">Grams</option>
              <option value="tlb">Troy Lb</option>
            </select>
          </div>
          <div class="form-group" id="scrapPurityGroup" style="display:none">
            <label class="form-label">Purity</label>
            <select class="form-select" id="scrapPurity"></select>
          </div>
          <div class="form-group" id="scrapWeightUnitGroup" style="display:none">
            <label class="form-label">Weight Unit</label>
            <select class="form-select" id="scrapWeightUnit">
              <option value="g">Grams</option>
              <option value="dwt">Pennyweight (dwt)</option>
              <option value="ozt">Troy Oz</option>
              <option value="tlb">Troy Lb</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Transaction Type</label>
            <div class="segment-control" id="calcType">
              <button class="segment-btn active" data-value="buy">Buying from Customer</button>
              <button class="segment-btn" data-value="sell">Selling to Customer</button>
              <button class="segment-btn" data-value="wholesale">Wholesaling</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" id="qtyLabel">Quantity (Troy Oz)</label>
            <input class="form-input" type="number" id="calcQty" placeholder="0.000" step="any" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Payment Method</label>
            <select class="form-select" id="calcPayment">
              <option value="cash">Cash</option>
              <option value="wire">Bank Wire</option>
              <option value="check">Check</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Notes (Optional)</label>
            <input class="form-input" type="text" id="calcNotes" placeholder="Transaction notes...">
          </div>
          <div class="form-group full-width">
            <label class="form-label">Customer (Optional)</label>
            <div class="customer-selector-wrapper">
              <input class="customer-input" type="text" id="customerSearch" placeholder="Search or add customer..." autocomplete="off">
              <button class="customer-clear-btn" id="customerClearBtn" type="button">&times;</button>
              <div class="customer-dropdown" id="customerDropdown"></div>
              <input type="hidden" id="selectedCustomerId">
            </div>
          </div>
        </div>
      </div>

      <div class="card calc-output" id="calcOutput">
        <div class="card-title">Deal Summary</div>
        <div class="output-row">
          <span class="output-label">Current Spot Price</span>
          <span class="output-value gold" id="outSpot">$0.00</span>
        </div>
        <div class="output-row">
          <span class="output-label" id="outPriceLabel">Our Buy Price / oz</span>
          <span class="output-value" id="outPrice">$0.00</span>
        </div>
        <div class="output-row">
          <span class="output-label">Margin / oz</span>
          <span class="output-value green" id="outMargin">$0.00</span>
        </div>
        <div class="output-row">
          <span class="output-label">Total Transaction Value</span>
          <span class="output-value large" id="outTotal">$0.00</span>
        </div>
        <div class="output-row">
          <span class="output-label">Total Profit on Deal</span>
          <span class="output-value profit-highlight" id="outProfit">$0.00</span>
        </div>
        <div class="compliance-warning" id="cashWarning">
          <span class="compliance-icon">âš </span>
          <div>
            <div id="cashWarningText">Cash transaction â‰¥ $10,000 â€” Form 8300 reporting required</div>
            <div id="cashWarningCustomer" style="font-size:12px;margin-top:4px;color:#e0a000;display:none;">Customer required for compliance</div>
          </div>
        </div>
        <div class="compliance-warning-1099b" id="warning1099B">
          <span class="compliance-icon">ğŸ“‹</span>
          <div>
            <div id="warning1099BText">IRS Form 1099-B reporting required for this buy-back</div>
            <div id="warning1099BW9" style="font-size:12px;margin-top:4px;color:#1976D2;display:none;">W-9 not on file for this customer â€” collect before completing transaction</div>
          </div>
        </div>
        <div id="dealLinesContainer" style="display:none;">
          <div class="deal-lines-container">
            <div class="deal-lines-header">
              <span>Deal Lines <span class="deal-lines-count" id="dealLinesCount">0</span></span>
            </div>
            <div id="dealLinesList"></div>
            <div class="deal-lines-totals">
              <span class="total-label">Combined Total: <span class="total-value" id="dealLinesTotal">$0.00</span></span>
              <span class="total-label">Profit: <span class="profit-value green" id="dealLinesProfit">+$0.00</span></span>
            </div>
          </div>
        </div>
        <div class="deal-action-buttons">
          <button class="add-line-btn" id="addLineBtn" disabled>+ Add Line</button>
          <button class="log-deal-btn" id="logDealBtn" disabled style="margin-top:0;">Log Deal</button>
        </div>
        <div class="deal-logged-msg" id="dealLoggedMsg">Deal logged successfully!</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRANSACTIONS PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="page-transactions">
    <div class="card">
      <div class="card-title">Transaction Log</div>
      <div class="filters-bar">
        <div class="form-group">
          <label class="form-label">From</label>
          <input class="form-input" type="date" id="filterFrom">
        </div>
        <div class="form-group">
          <label class="form-label">To</label>
          <input class="form-input" type="date" id="filterTo">
        </div>
        <div class="form-group">
          <label class="form-label">Metal</label>
          <select class="form-select" id="filterMetal">
            <option value="">All</option>
            <option value="gold">Gold</option>
            <option value="silver">Silver</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Form</label>
          <select class="form-select" id="filterForm">
            <option value="">All</option>
            <option value="coins">Coins</option>
            <option value="bars">Bars</option>
            <option value="rounds">Rounds</option>
            <option value="junk">Junk Silver</option>
            <option value="scrap">Scrap</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="form-select" id="filterType">
            <option value="">All</option>
            <option value="buy">Retail Buy</option>
            <option value="sell">Retail Sell</option>
            <option value="wholesale">Wholesale</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Customer</label>
          <select class="form-select" id="filterCustomer">
            <option value="">All</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Compliance</label>
          <select class="form-select" id="filterCompliance">
            <option value="">All</option>
            <option value="flagged">8300 Flagged</option>
            <option value="needs-review">8300 Needs Review</option>
            <option value="reviewed">8300 Reviewed</option>
            <option value="1099b-flagged">1099-B Flagged</option>
            <option value="1099b-needs-filing">1099-B Needs Filing</option>
            <option value="1099b-filed">1099-B Filed</option>
            <option value="any-compliance">Any Compliance Flag</option>
          </select>
        </div>
        <button class="filter-btn" id="clearFiltersBtn">Clear</button>
        <button class="export-btn" id="exportCsvBtn">Export CSV</button>
      </div>
      <div style="overflow-x: auto;">
        <table id="txTable">
          <thead>
            <tr>
              <th data-sort="date">Date <span class="sort-arrow">â–¼</span></th>
              <th>Metal</th>
              <th>Form</th>
              <th data-sort="type">Type</th>
              <th>Customer</th>
              <th>Qty</th>
              <th>Spot</th>
              <th>Our Price</th>
              <th data-sort="total">Total</th>
              <th>Payment</th>
              <th data-sort="profit">Profit</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
      <div class="empty-state" id="txEmpty">No transactions yet. Use the Calculator to log your first deal.</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INVENTORY PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="page-inventory">
    <div class="inventory-grid">
      <div class="inventory-card gold-card">
        <div class="inventory-metal-label gold">Gold Holdings</div>
        <div class="inventory-oz" id="invGoldOz">0.000</div>
        <div class="inventory-oz-label">troy ounces</div>
        <div class="inventory-value" id="invGoldValue">$0.00</div>
        <div class="inventory-breakdown" id="invGoldBreakdown"></div>
      </div>
      <div class="inventory-card silver-card">
        <div class="inventory-metal-label silver">Silver Holdings</div>
        <div class="inventory-oz" id="invSilverOz">0.000</div>
        <div class="inventory-oz-label">troy ounces</div>
        <div class="inventory-value" id="invSilverValue">$0.00</div>
        <div class="inventory-breakdown" id="invSilverBreakdown"></div>
      </div>
    </div>

    <div class="card" id="invReorderAlerts">
      <div class="card-title">Reorder Alerts</div>
      <div id="invReorderList"></div>
      <div class="empty-state" id="invReorderEmpty" style="padding:12px;">All inventory levels are above reorder points.</div>
    </div>

    <div class="card">
      <div class="card-title">Wholesale Contact Directory</div>
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <input class="form-input" type="text" id="contactName" placeholder="Name" style="flex:1;min-width:120px;">
        <input class="form-input" type="text" id="contactCompany" placeholder="Company" style="flex:1;min-width:120px;">
        <input class="form-input" type="text" id="contactPhone" placeholder="Phone" style="flex:1;min-width:120px;">
        <input class="form-input" type="text" id="contactNotes" placeholder="Notes" style="flex:2;min-width:120px;">
        <button class="filter-btn" id="addContactBtn" style="background:var(--gold);color:#0a0a0a;border-color:var(--gold);">Add</button>
      </div>
      <div class="contacts-list" id="contactsList"></div>
      <div class="empty-state" id="contactsEmpty" style="padding:20px;">No wholesale contacts saved yet.</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CUSTOMERS PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="page-customers">
    <div class="customers-search-bar">
      <input type="text" id="customersSearchInput" placeholder="Search by name or phone...">
      <button id="customersAddBtn">Add Customer</button>
    </div>
    <div class="card">
      <div class="card-title">Customer Directory</div>
      <table class="customers-table" id="customersTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>W-9</th>
            <th>Transactions</th>
            <th>Total Volume</th>
            <th>8300 Flags</th>
            <th>1099-B Flags</th>
          </tr>
        </thead>
        <tbody id="customersTableBody"></tbody>
      </table>
      <div class="empty-state" id="customersEmpty" style="display:none;">No customers yet. Use the Calculator to add your first customer.</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• P&L PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="page-pnl">
    <div class="pnl-period-selector">
      <button class="period-btn active" data-period="daily">Daily</button>
      <button class="period-btn" data-period="weekly">Weekly</button>
      <button class="period-btn" data-period="monthly">Monthly</button>
    </div>
    <div class="pnl-grid">
      <div class="pnl-card">
        <div class="pnl-card-label">Total Bought (Cost)</div>
        <div class="pnl-card-value" id="pnlBought">$0.00</div>
        <div class="pnl-card-sub" id="pnlBoughtCount">0 transactions</div>
      </div>
      <div class="pnl-card">
        <div class="pnl-card-label">Total Sold (Revenue)</div>
        <div class="pnl-card-value gold" id="pnlSold">$0.00</div>
        <div class="pnl-card-sub" id="pnlSoldCount">0 transactions</div>
      </div>
      <div class="pnl-card">
        <div class="pnl-card-label">Realized Profit</div>
        <div class="pnl-card-value green" id="pnlProfit">$0.00</div>
        <div class="pnl-card-sub" id="pnlMarginPct">0% margin</div>
      </div>
      <div class="pnl-card">
        <div class="pnl-card-label">Gold Holdings</div>
        <div class="pnl-card-value gold" id="pnlGold">0.000 oz</div>
        <div class="pnl-card-sub" id="pnlGoldVal">$0.00 at spot</div>
      </div>
      <div class="pnl-card">
        <div class="pnl-card-label">Silver Holdings</div>
        <div class="pnl-card-value" id="pnlSilver" style="color:var(--silver)">0.000 oz</div>
        <div class="pnl-card-sub" id="pnlSilverVal">$0.00 at spot</div>
      </div>
      <div class="pnl-card">
        <div class="pnl-card-label">Wholesale Volume</div>
        <div class="pnl-card-value" id="pnlWholesale">$0.00</div>
        <div class="pnl-card-sub" id="pnlWholesaleCount">0 transactions</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Capital Position</div>
      <div style="display:flex;gap:24px;flex-wrap:wrap;">
        <div>
          <div class="pnl-card-label">Cash In</div>
          <div class="pnl-card-value" id="pnlCashIn" style="font-size:22px;">$0.00</div>
        </div>
        <div>
          <div class="pnl-card-label">Cash Out</div>
          <div class="pnl-card-value" id="pnlCashOut" style="font-size:22px;">$0.00</div>
        </div>
        <div>
          <div class="pnl-card-label">Inventory Value at Spot</div>
          <div class="pnl-card-value gold" id="pnlInvValue" style="font-size:22px;">$0.00</div>
        </div>
        <div>
          <div class="pnl-card-label">Running Capital</div>
          <div class="pnl-card-value green" id="pnlCapital" style="font-size:22px;">$0.00</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page" id="page-settings">
    <div class="card">
      <div class="settings-section">
        <div class="settings-section-title">Shop Info</div>
        <div class="form-group" style="max-width:300px;">
          <label class="form-label">Shop Name</label>
          <input class="form-input" type="text" id="settingShopName" placeholder="My Bullion Shop">
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Sell Premiums (Spot + %)</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Coins %</label>
            <input class="form-input" type="number" id="sellPremCoins" step="0.1" value="7">
          </div>
          <div class="form-group">
            <label class="form-label">Bars & Rounds %</label>
            <input class="form-input" type="number" id="sellPremBars" step="0.1" value="5">
          </div>
          <div class="form-group">
            <label class="form-label">Scrap %</label>
            <input class="form-input" type="number" id="sellPremScrap" step="0.1" value="3">
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Buy Discounts (Spot âˆ’ %)</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Coins %</label>
            <input class="form-input" type="number" id="buyDiscCoins" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label class="form-label">Bars & Rounds %</label>
            <input class="form-input" type="number" id="buyDiscBars" step="0.1" value="5">
          </div>
          <div class="form-group">
            <label class="form-label">Scrap %</label>
            <input class="form-input" type="number" id="buyDiscScrap" step="0.1" value="8">
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Wholesale Discounts (Spot âˆ’ %)</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Coins %</label>
            <input class="form-input" type="number" id="whDiscCoins" step="0.1" value="1">
          </div>
          <div class="form-group">
            <label class="form-label">Bars & Rounds %</label>
            <input class="form-input" type="number" id="whDiscBars" step="0.1" value="2">
          </div>
          <div class="form-group">
            <label class="form-label">Scrap %</label>
            <input class="form-input" type="number" id="whDiscScrap" step="0.1" value="3">
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Coin Type Adjustments (added to base coins %)</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">American Eagles %</label>
            <input class="form-input" type="number" id="adjEagles" step="0.1" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Maple Leafs %</label>
            <input class="form-input" type="number" id="adjMaples" step="0.1" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Krugerrands %</label>
            <input class="form-input" type="number" id="adjKrugerrands" step="0.1" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Britannias %</label>
            <input class="form-input" type="number" id="adjBritannias" step="0.1" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Philharmonics %</label>
            <input class="form-input" type="number" id="adjPhilharmonics" step="0.1" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Pre-1933 US Gold %</label>
            <input class="form-input" type="number" id="adjPre33" step="0.1" value="0">
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Junk Silver</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Silver Weight per $1 FV</label>
            <input class="form-input" type="number" id="junkMultiplier" step="0.001" value="0.715">
          </div>
          <div class="form-group">
            <label class="form-label">Manual Multiplier Override</label>
            <input class="form-input" type="number" id="junkMultOverride" step="0.1" placeholder="Leave blank for auto">
          </div>
          <div class="form-group">
            <label class="form-label">Sell Premium %</label>
            <input class="form-input" type="number" id="sellPremJunk" step="0.1" value="7">
          </div>
          <div class="form-group">
            <label class="form-label">Buy Discount %</label>
            <input class="form-input" type="number" id="buyDiscJunk" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label class="form-label">Wholesale Discount %</label>
            <input class="form-input" type="number" id="whDiscJunk" step="0.1" value="1">
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Wholesale Thresholds (Alert when inventory exceeds)</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Gold (oz)</label>
            <input class="form-input" type="number" id="threshGold" step="0.1" value="10">
          </div>
          <div class="form-group">
            <label class="form-label">Silver (oz)</label>
            <input class="form-input" type="number" id="threshSilver" step="1" value="500">
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Reorder Alerts (Low-stock warning when inventory drops below)</div>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Set to 0 to disable alerts for that form.</div>
        <div style="font-size:13px;font-weight:600;margin-bottom:6px;color:var(--gold);">Gold (oz)</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Coins</label>
            <input class="form-input" type="number" id="reorderGoldCoins" step="0.1" value="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Bars</label>
            <input class="form-input" type="number" id="reorderGoldBars" step="0.1" value="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Rounds</label>
            <input class="form-input" type="number" id="reorderGoldRounds" step="0.1" value="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Scrap</label>
            <input class="form-input" type="number" id="reorderGoldScrap" step="0.1" value="0" min="0">
          </div>
        </div>
        <div style="font-size:13px;font-weight:600;margin:12px 0 6px;color:var(--silver);">Silver (oz)</div>
        <div class="settings-grid">
          <div class="form-group">
            <label class="form-label">Coins</label>
            <input class="form-input" type="number" id="reorderSilverCoins" step="1" value="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Bars</label>
            <input class="form-input" type="number" id="reorderSilverBars" step="1" value="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Rounds</label>
            <input class="form-input" type="number" id="reorderSilverRounds" step="1" value="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Junk</label>
            <input class="form-input" type="number" id="reorderSilverJunk" step="1" value="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Scrap</label>
            <input class="form-input" type="number" id="reorderSilverScrap" step="1" value="0" min="0">
          </div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Data Management</div>
        <div class="data-mgmt-actions">
          <button class="data-export-btn" id="exportDataBtn">Export Data</button>
          <button class="data-import-btn" id="importDataBtn">Import Data</button>
        </div>
        <input type="file" id="importFileInput" accept=".json" style="display:none;">
        <span class="save-confirm" id="dataConfirm"></span>
      </div>

      <button class="settings-save-btn" id="saveSettingsBtn">Save Settings</button>
      <span class="save-confirm" id="saveConfirm">Settings saved!</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EDIT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title" id="editModalTitle">Edit Transaction</div>
    <input type="hidden" id="editTxId">
    <div style="display:grid;gap:12px;">
      <div class="form-group">
        <label class="form-label">Metal</label>
        <select class="form-select" id="editMetal">
          <option value="gold">Gold</option>
          <option value="silver">Silver</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Form</label>
        <select class="form-select" id="editForm">
          <option value="coins">Coins</option>
          <option value="bars">Bars</option>
          <option value="rounds">Rounds</option>
          <option value="junk">Junk Silver</option>
          <option value="scrap">Scrap</option>
        </select>
      </div>
      <div class="form-group" id="editCoinTypeGroup" style="display:none;">
        <label class="form-label">Coin Type</label>
        <select class="form-select" id="editCoinType">
          <option value="">None</option>
          <option value="eagles">American Eagles</option>
          <option value="maples">Maple Leafs</option>
          <option value="krugerrands">Krugerrands</option>
          <option value="britannias">Britannias</option>
          <option value="philharmonics">Philharmonics</option>
          <option value="pre33_20">$20 Double Eagle</option>
          <option value="pre33_10">$10 Eagle</option>
          <option value="pre33_5">$5 Half Eagle</option>
          <option value="pre33_250">$2.50 Quarter Eagle</option>
        </select>
      </div>
      <div class="form-group" id="editScrapPurityGroup" style="display:none;">
        <label class="form-label">Purity</label>
        <select class="form-select" id="editScrapPurity"></select>
      </div>
      <div class="form-group" id="editScrapWeightUnitGroup" style="display:none;">
        <label class="form-label">Weight Unit</label>
        <select class="form-select" id="editScrapWeightUnit">
          <option value="g">Grams</option>
          <option value="dwt">Pennyweight (dwt)</option>
          <option value="ozt">Troy Oz</option>
          <option value="tlb">Troy Lb</option>
        </select>
      </div>
      <div class="form-group" id="editWeightUnitGroup" style="display:none;">
        <label class="form-label">Weight Unit</label>
        <select class="form-select" id="editWeightUnit">
          <option value="ozt">Troy Oz</option>
          <option value="g">Grams</option>
          <option value="tlb">Troy Lb</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="editType">
          <option value="buy">Retail Buy</option>
          <option value="sell">Retail Sell</option>
          <option value="wholesale">Wholesale</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Quantity</label>
        <input class="form-input" type="number" id="editQty" step="any" min="0.01" required>
      </div>
      <div class="form-group">
        <label class="form-label">Spot Price at Time</label>
        <input class="form-input" type="number" id="editSpot" step="0.01" min="0.01" required>
      </div>
      <div class="form-group">
        <label class="form-label">Our Price / oz</label>
        <input class="form-input" type="number" id="editPrice" step="0.01" min="0.01" required>
      </div>
      <div class="form-group">
        <label class="form-label">Payment Method</label>
        <select class="form-select" id="editPayment">
          <option value="cash">Cash</option>
          <option value="wire">Bank Wire</option>
          <option value="check">Check</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Customer</label>
        <select class="form-select" id="editCustomer">
          <option value="">None</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <input class="form-input" type="text" id="editNotes" placeholder="Transaction notes...">
      </div>
      <div class="form-group" id="editForm8300Group" style="display:none;">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-primary);cursor:pointer;">
          <input type="checkbox" id="editForm8300Reviewed">
          Marked as reviewed (Form 8300 filed)
        </label>
      </div>
      <div class="form-group" id="editForm1099BGroup" style="display:none;">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#FF9800;cursor:pointer;">
          <input type="checkbox" id="editForm1099BFiled">
          Marked as filed (1099-B submitted)
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" id="editCancelBtn">Cancel</button>
      <button class="modal-btn primary" id="editSaveBtn">Save Changes</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DELETE CONFIRM MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-title">Delete Transaction</div>
    <p style="color:var(--text-secondary);margin-bottom:4px;">Are you sure? This cannot be undone.</p>
    <input type="hidden" id="deleteTxId">
    <div class="modal-actions">
      <button class="modal-btn secondary" id="deleteCancelBtn">Cancel</button>
      <button class="modal-btn danger" id="deleteConfirmBtn">Delete</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RECEIPT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="receiptModal">
  <div class="modal" style="max-width:460px;padding:16px;">
    <div class="receipt-content" id="receiptContent"></div>
    <div class="receipt-actions">
      <button class="modal-btn secondary" id="receiptCloseBtn">Close</button>
      <button class="modal-btn primary" id="receiptPrintBtn">Print Receipt</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD CUSTOMER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="addCustomerModal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-title">Add New Customer</div>
    <div style="display:grid;gap:12px;">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" type="text" id="newCustomerName" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">Phone</label>
        <input class="form-input" type="text" id="newCustomerPhone" placeholder="Phone number">
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <input class="form-input" type="text" id="newCustomerNotes" placeholder="Optional notes">
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-primary);cursor:pointer;">
          <input type="checkbox" id="newCustomerW9">
          W-9 on file
        </label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn secondary" id="addCustomerCancelBtn">Cancel</button>
      <button class="modal-btn primary" id="addCustomerSaveBtn">Save Customer</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CUSTOMER PROFILE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="customer-profile-overlay" id="customerProfileOverlay">
  <div class="customer-profile-modal">
    <div class="cp-header">
      <div class="cp-header-left">
        <h2 id="cpName">Customer Name</h2>
        <div class="cp-fields">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input class="form-input" type="email" id="cpEmail" placeholder="Email address">
          </div>
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input class="form-input" type="text" id="cpPhone" placeholder="Phone number">
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <input class="form-input" type="text" id="cpNotes" placeholder="Notes">
          </div>
          <div class="form-group" style="display:flex;align-items:flex-end;">
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-primary);cursor:pointer;">
              <input type="checkbox" id="cpW9">
              W-9 on file
            </label>
          </div>
        </div>
      </div>
      <div class="cp-header-right">
        <button class="modal-btn danger" id="cpDeleteBtn">Delete</button>
        <button class="modal-btn primary" id="cpSaveBtn">Save</button>
        <button class="modal-btn secondary" id="cpCloseBtn">Close</button>
      </div>
    </div>

    <div class="cp-stats-grid">
      <div class="cp-stat-card">
        <div class="cp-stat-label">Total Transactions</div>
        <div class="cp-stat-value" id="cpTotalTx">0</div>
      </div>
      <div class="cp-stat-card">
        <div class="cp-stat-label">Total Bought ($)</div>
        <div class="cp-stat-value gold" id="cpTotalBought">$0.00</div>
      </div>
      <div class="cp-stat-card">
        <div class="cp-stat-label">Total Sold ($)</div>
        <div class="cp-stat-value" id="cpTotalSold">$0.00</div>
      </div>
      <div class="cp-stat-card">
        <div class="cp-stat-label">Net P&L</div>
        <div class="cp-stat-value green" id="cpNetPnl">$0.00</div>
      </div>
    </div>

    <div class="cp-compliance" id="cpCompliance"></div>

    <div class="cp-section-title">Transaction History</div>
    <div style="overflow-x: auto;">
      <table class="cp-tx-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Metal</th>
            <th>Form</th>
            <th>Type</th>
            <th>Qty</th>
            <th>Total</th>
            <th>Profit</th>
            <th>Payment</th>
            <th>Compliance</th>
          </tr>
        </thead>
        <tbody id="cpTxBody"></tbody>
      </table>
    </div>
    <div class="empty-state" id="cpTxEmpty" style="display:none;">No transactions for this customer.</div>

    <input type="hidden" id="cpCustomerId">
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STACKTRACK â€” CORE APPLICATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€â”€ Data Store â”€â”€â”€
const Store = {
  get(key, fallback) {
    try { const v = localStorage.getItem('st_' + key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  },
  set(key, val) { localStorage.setItem('st_' + key, JSON.stringify(val)); }
};

// â”€â”€â”€ Pre-1933 Gold Content (troy oz per coin) â”€â”€â”€
const PRE33_GOLD_CONTENT = {
  pre33_20: 0.9675,
  pre33_10: 0.48375,
  pre33_5: 0.24187,
  pre33_250: 0.12094
};

// â”€â”€â”€ Scrap Purity & Weight Units â”€â”€â”€
const SCRAP_PURITIES = {
  gold: {
    '8k':  { label: '8K Gold',  fineness: 8/24 },
    '9k':  { label: '9K Gold',  fineness: 9/24 },
    '10k': { label: '10K Gold', fineness: 10/24 },
    '14k': { label: '14K Gold', fineness: 14/24 },
    '18k': { label: '18K Gold', fineness: 18/24 },
    '22k': { label: '22K Gold', fineness: 22/24 },
    '24k': { label: '24K Gold', fineness: 24/24 },
  },
  silver: {
    '800': { label: '.800 Silver', fineness: 0.800 },
    '900': { label: '.900 Silver', fineness: 0.900 },
    '925': { label: '.925 Sterling', fineness: 0.925 },
    '999': { label: '.999 Fine', fineness: 0.999 },
  }
};
const WEIGHT_UNITS = {
  g:   { label: 'Grams',       toTroyOz: 1 / 31.1035 },
  dwt: { label: 'Pennyweight', toTroyOz: 1 / 20 },
  ozt: { label: 'Troy Oz',     toTroyOz: 1 },
  tlb: { label: 'Troy Lb',     toTroyOz: 12 },
};

// â”€â”€â”€ Default Settings â”€â”€â”€
const DEFAULT_SETTINGS = {
  shopName: 'My Bullion Shop',
  sellPremCoins: 7, sellPremBars: 5, sellPremScrap: 3,
  buyDiscCoins: 3, buyDiscBars: 5, buyDiscScrap: 8,
  whDiscCoins: 1, whDiscBars: 2, whDiscScrap: 3,
  coinAdjustments: { eagles: 0, maples: 0, krugerrands: 0, britannias: 0, philharmonics: 0, pre33: 0 },
  junkMultiplier: 0.715, junkMultOverride: null,
  sellPremJunk: 7, buyDiscJunk: 3, whDiscJunk: 1,
  threshGold: 10, threshSilver: 500,
  reorderPoints: {
    goldCoins: 0, goldBars: 0, goldRounds: 0, goldScrap: 0,
    silverCoins: 0, silverBars: 0, silverRounds: 0, silverJunk: 0, silverScrap: 0
  }
};

let settings = { ...DEFAULT_SETTINGS, ...Store.get('settings', {}) };
if (!settings.coinAdjustments) settings.coinAdjustments = { ...DEFAULT_SETTINGS.coinAdjustments };
if (!settings.reorderPoints) settings.reorderPoints = { ...DEFAULT_SETTINGS.reorderPoints };
// Migrate junkDivisor â†’ junkMultiplier
if (settings.junkDivisor !== undefined && settings.junkMultiplier === undefined) {
  settings.junkMultiplier = 0.715;
  delete settings.junkDivisor;
}
if (settings.sellPremJunk === undefined) {
  settings.sellPremJunk = settings.sellPremCoins || DEFAULT_SETTINGS.sellPremJunk;
  settings.buyDiscJunk = settings.buyDiscCoins || DEFAULT_SETTINGS.buyDiscJunk;
  settings.whDiscJunk = settings.whDiscCoins || DEFAULT_SETTINGS.whDiscJunk;
}
let transactions = Store.get('transactions', []);
let contacts = Store.get('contacts', []);
let customers = Store.get('customers', []);
let selectedCustomer = null;

function getCustomerName(id) {
  if (!id) return '';
  const c = customers.find(c => c.id === id);
  return c ? c.name : '';
}

function populateEditCustomerSelect() {
  const sel = $('editCustomer');
  sel.innerHTML = '<option value="">None</option>' +
    customers.map(c => `<option value="${esc(c.id)}">${esc(c.name)}</option>`).join('');
}

function populateFilterCustomerSelect() {
  const sel = $('filterCustomer');
  const current = sel.value;
  sel.innerHTML = '<option value="">All</option>' +
    customers.map(c => `<option value="${esc(c.id)}">${esc(c.name)}</option>`).join('');
  sel.value = current;
}

// â”€â”€â”€ Spot Prices (Live via gold-api.com) â”€â”€â”€
let spotPrices = {
  gold: 0,
  silver: 0,
  goldPrev: 0,
  silverPrev: 0,
  lastUpdated: 0,
  apiFailed: false
};

async function fetchSpotPrices() {
  try {
    const [goldRes, silverRes] = await Promise.all([
      fetch('https://api.gold-api.com/price/XAU'),
      fetch('https://api.gold-api.com/price/XAG')
    ]);

    if (!goldRes.ok || !silverRes.ok) throw new Error('API response not OK');

    const goldData = await goldRes.json();
    const silverData = await silverRes.json();

    if (!goldData.price || !silverData.price) throw new Error('Missing price data');

    spotPrices.goldPrev = spotPrices.gold || goldData.price;
    spotPrices.silverPrev = spotPrices.silver || silverData.price;
    spotPrices.gold = goldData.price;
    spotPrices.silver = silverData.price;
    spotPrices.lastUpdated = Date.now();
    spotPrices.apiFailed = false;

    $('spotWarning').style.display = 'none';
    updateSpotDisplay();
    recalcDeal();
    updateInventoryPage();
    updatePnlPage();
    updateDashboard();
  } catch (err) {
    console.warn('Spot price fetch failed:', err.message);
    spotPrices.apiFailed = true;
    $('spotWarning').style.display = 'block';
    // Keep last known prices â€” don't zero them out
  }
}

function updateSpotDisplay() {
  const fmt = (v) => '$' + v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  document.getElementById('goldSpot').textContent = fmt(spotPrices.gold);
  document.getElementById('silverSpot').textContent = fmt(spotPrices.silver);

  const goldPct = spotPrices.goldPrev ? ((spotPrices.gold - spotPrices.goldPrev) / spotPrices.goldPrev * 100) : 0;
  const silverPct = spotPrices.silverPrev ? ((spotPrices.silver - spotPrices.silverPrev) / spotPrices.silverPrev * 100) : 0;

  const goldEl = document.getElementById('goldChange');
  goldEl.textContent = (goldPct >= 0 ? '+' : '') + goldPct.toFixed(2) + '%';
  goldEl.className = 'spot-change ' + (goldPct >= 0 ? 'up' : 'down');

  const silverEl = document.getElementById('silverChange');
  silverEl.textContent = (silverPct >= 0 ? '+' : '') + silverPct.toFixed(2) + '%';
  silverEl.className = 'spot-change ' + (silverPct >= 0 ? 'up' : 'down');

  const ago = Math.round((Date.now() - spotPrices.lastUpdated) / 1000);
  document.getElementById('spotUpdated').textContent = ago < 5 ? 'Updated just now' : `Updated ${ago}s ago`;
}

// Fetch live prices immediately, then every 60 seconds
fetchSpotPrices();
setInterval(fetchSpotPrices, 60000);
// Update "ago" display every 10 seconds
setInterval(() => {
  if (spotPrices.lastUpdated === 0) {
    document.getElementById('spotUpdated').textContent = 'Loading...';
    return;
  }
  const ago = Math.round((Date.now() - spotPrices.lastUpdated) / 1000);
  document.getElementById('spotUpdated').textContent = ago < 5 ? 'Updated just now' : `Updated ${ago}s ago`;
}, 10000);

// â”€â”€â”€ Theme â”€â”€â”€
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  Store.set('theme', theme);
}

document.getElementById('themeToggle').addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  setTheme(current === 'dark' ? 'light' : 'dark');
});

// Load saved theme
setTheme(Store.get('theme', 'dark'));

// â”€â”€â”€ Navigation â”€â”€â”€
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    item.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + item.dataset.page).classList.add('active');
    // Refresh data on page switch
    if (item.dataset.page === 'dashboard') updateDashboard();
    if (item.dataset.page === 'transactions') renderTransactions();
    if (item.dataset.page === 'inventory') updateInventoryPage();
    if (item.dataset.page === 'customers') renderCustomersPage();
    if (item.dataset.page === 'pnl') updatePnlPage();
  });
});

// â”€â”€â”€ Helpers â”€â”€â”€
const $ = id => document.getElementById(id);
const fmt = (v) => '$' + Math.abs(v).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtOz = (v) => v.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function getFormLabel(form) {
  return { coins: 'Coins', bars: 'Bars', rounds: 'Rounds', junk: 'Junk Silver', scrap: 'Scrap' }[form] || form;
}

function isPre33(coinType) { return coinType && coinType.startsWith('pre33'); }

function getCoinTypeLabel(coinType) {
  return { eagles: 'American Eagles', maples: 'Maple Leafs', krugerrands: 'Krugerrands', britannias: 'Britannias', philharmonics: 'Philharmonics', pre33_20: '$20 Double Eagle', pre33_10: '$10 Eagle', pre33_5: '$5 Half Eagle', pre33_250: '$2.50 Quarter Eagle' }[coinType] || '';
}

function getFormDisplayLabel(form, coinType) {
  if (form === 'coins' && coinType) return 'Coins (' + getCoinTypeLabel(coinType) + ')';
  return getFormLabel(form);
}

function getTypeLabel(type) {
  return { buy: 'Retail Buy', sell: 'Retail Sell', wholesale: 'Wholesale' }[type] || type;
}

function populateScrapPurities(metal) {
  const sel = $('scrapPurity');
  const purities = SCRAP_PURITIES[metal] || {};
  sel.innerHTML = Object.entries(purities).map(([key, p]) =>
    `<option value="${key}">${p.label}</option>`
  ).join('');
  // Default: 14k for gold, 925 for silver
  if (metal === 'gold') sel.value = '14k';
  else if (metal === 'silver') sel.value = '925';
}

function getWeightInTroyOz(rawQty) {
  const unit = $('calcWeightUnit').value;
  return rawQty * WEIGHT_UNITS[unit].toTroyOz;
}

function getScrapFineOz(rawQty) {
  const unit = $('scrapWeightUnit').value;
  const purityKey = $('scrapPurity').value;
  const metal = calcMetal.value;
  const purity = (SCRAP_PURITIES[metal] || {})[purityKey];
  const troyOz = rawQty * WEIGHT_UNITS[unit].toTroyOz;
  return troyOz * (purity ? purity.fineness : 1);
}

function getTxLines(tx) {
  if (tx.lines && tx.lines.length > 0) return tx.lines;
  const line = { metal: tx.metal, form: tx.form, coinType: tx.coinType, qty: tx.qty, spot: tx.spot, price: tx.price, total: tx.total, profit: tx.profit };
  if (tx.scrapPurity) { line.scrapPurity = tx.scrapPurity; line.scrapWeightUnit = tx.scrapWeightUnit; line.rawQty = tx.rawQty; }
  if (tx.weightUnit) { line.weightUnit = tx.weightUnit; line.rawQty = tx.rawQty; }
  return [line];
}

// â”€â”€â”€ 24-Hour Cash Aggregation (Form 8300) â”€â”€â”€
function get24HourCashTotal(customerId, referenceDate, excludeTxId) {
  if (!customerId) return 0;
  const refMs = new Date(referenceDate).getTime();
  const windowMs = 86400000; // 24 hours
  return transactions.reduce((sum, t) => {
    if (excludeTxId && t.id === excludeTxId) return sum;
    if (t.customerId !== customerId) return sum;
    if (t.payment !== 'cash') return sum;
    if (t.total <= 0) return sum;
    if (Math.abs(new Date(t.date).getTime() - refMs) > windowMs) return sum;
    return sum + t.total;
  }, 0);
}

// â”€â”€â”€ 1099-B Compliance (Dealer Buy-Backs) â”€â”€â”€
function is1099BReportableProduct(metal, form, coinType) {
  // Gold bars/rounds (.995+)
  if (metal === 'gold' && (form === 'bars' || form === 'rounds')) return true;
  // Silver bars/rounds (.999+)
  if (metal === 'silver' && (form === 'bars' || form === 'rounds')) return true;
  // Gold Maple Leafs
  if (metal === 'gold' && form === 'coins' && coinType === 'maples') return true;
  // Gold Krugerrands
  if (metal === 'gold' && form === 'coins' && coinType === 'krugerrands') return true;
  // 90% Junk Silver
  if (form === 'junk') return true;
  // NOT reportable: American Eagles, Britannias, Philharmonics, scrap
  return false;
}

function get1099BThreshold(metal, form, coinType) {
  if (metal === 'gold' && (form === 'bars' || form === 'rounds')) return 32.15; // 1 kilo
  if (metal === 'silver' && (form === 'bars' || form === 'rounds')) return 1000;
  if (metal === 'gold' && form === 'coins' && coinType === 'maples') return 25;
  if (metal === 'gold' && form === 'coins' && coinType === 'krugerrands') return 25;
  if (form === 'junk') return 1000; // $1,000 face value
  return Infinity;
}

function get1099BProductKey(metal, form, coinType) {
  if (form === 'junk') return 'junk';
  if (form === 'coins' && coinType) return metal + ':coins:' + coinType;
  return metal + ':' + form;
}

function get24Hour1099BQty(customerId, metal, form, coinType, referenceDate, excludeTxId) {
  if (!customerId) return 0;
  const key = get1099BProductKey(metal, form, coinType);
  const refMs = new Date(referenceDate).getTime();
  const windowMs = 86400000;
  return transactions.reduce((sum, t) => {
    if (excludeTxId && t.id === excludeTxId) return sum;
    if (t.customerId !== customerId) return sum;
    if (t.type !== 'buy') return sum;
    if (Math.abs(new Date(t.date).getTime() - refMs) > windowMs) return sum;
    let lineSum = 0;
    getTxLines(t).forEach(l => {
      if (get1099BProductKey(l.metal, l.form, l.coinType) === key) lineSum += l.qty;
    });
    return sum + lineSum;
  }, 0);
}

function check1099B(tx, excludeTxId) {
  // Only applies to buy transactions (dealer buying from customer)
  if (tx.type !== 'buy') return { reportable: false, reason: '' };
  if (!is1099BReportableProduct(tx.metal, tx.form, tx.coinType)) return { reportable: false, reason: '' };

  const threshold = get1099BThreshold(tx.metal, tx.form, tx.coinType);
  const unit = tx.form === 'junk' ? 'face value' : 'oz';

  // Single transaction check
  if (tx.qty >= threshold) {
    return { reportable: true, reason: `Single buy of ${tx.qty} ${unit} meets ${threshold} ${unit} threshold` };
  }

  // 24-hour aggregation check
  if (tx.customerId) {
    const prior = get24Hour1099BQty(tx.customerId, tx.metal, tx.form, tx.coinType, tx.date, excludeTxId);
    const combined = prior + tx.qty;
    if (combined >= threshold) {
      return { reportable: true, reason: `Combined 24hr buy-back qty (${combined.toFixed(3)} ${unit}) meets ${threshold} ${unit} threshold` };
    }
  }

  return { reportable: false, reason: '' };
}

// â”€â”€â”€ Pricing Engine â”€â”€â”€
function getMargin(txType, form, coinType) {
  let base = 0;
  if (txType === 'buy') {
    if (form === 'coins') base = -settings.buyDiscCoins / 100;
    else if (form === 'bars' || form === 'rounds') base = -settings.buyDiscBars / 100;
    else if (form === 'scrap') base = -settings.buyDiscScrap / 100;
  } else if (txType === 'sell') {
    if (form === 'coins') base = settings.sellPremCoins / 100;
    else if (form === 'bars' || form === 'rounds') base = settings.sellPremBars / 100;
    else if (form === 'scrap') base = settings.sellPremScrap / 100;
  } else if (txType === 'wholesale') {
    if (form === 'coins') base = -settings.whDiscCoins / 100;
    else if (form === 'bars' || form === 'rounds') base = -settings.whDiscBars / 100;
    else if (form === 'scrap') base = -settings.whDiscScrap / 100;
  }
  if (form === 'coins' && coinType) {
    const adjKey = coinType.startsWith('pre33') ? 'pre33' : coinType;
    const adj = (settings.coinAdjustments || {})[adjKey] || 0;
    if (txType === 'buy') base -= adj / 100;
    else base += adj / 100;
  }
  return base;
}

function calcDealPrice(metal, form, txType, coinType) {
  const spot = metal === 'gold' ? spotPrices.gold : spotPrices.silver;

  if (form === 'junk') {
    // Junk silver: multiplier-based
    const multiplier = settings.junkMultOverride || (spot * settings.junkMultiplier);
    // For junk, the "price" is the multiplier * face value
    // We still apply a margin adjustment for buy vs sell
    let adj = 1;
    if (txType === 'buy') adj = 1 - settings.buyDiscJunk / 100;
    else if (txType === 'sell') adj = 1 + settings.sellPremJunk / 100;
    else if (txType === 'wholesale') adj = 1 - settings.whDiscJunk / 100;
    return { spot, pricePerUnit: multiplier * adj, multiplier, isJunk: true };
  }

  const margin = getMargin(txType, form, coinType);
  const pricePerOz = spot * (1 + margin);
  return { spot, pricePerOz, margin, isJunk: false };
}

// â”€â”€â”€ Deal Lines State â”€â”€â”€
let dealLines = [];

function getLineDescription(line) {
  const metalLabel = line.metal === 'gold' ? 'Gold' : 'Silver';
  if (line.form === 'scrap' && line.scrapPurity) {
    const purity = (SCRAP_PURITIES[line.metal] || {})[line.scrapPurity];
    const purityLabel = purity ? purity.label.replace(/\s*(Gold|Silver)$/, '') : line.scrapPurity;
    const unitLabel = line.scrapWeightUnit ? WEIGHT_UNITS[line.scrapWeightUnit].label : '';
    return `${metalLabel} Scrap (${purityLabel}) â€” ${line.rawQty}${line.scrapWeightUnit === 'g' ? 'g' : line.scrapWeightUnit === 'dwt' ? ' dwt' : ' ozt'} â†’ ${fmtOz(line.qty)} fine oz`;
  }
  const formLabel = getFormDisplayLabel(line.form, line.coinType);
  let qtyLabel;
  if (line.form === 'junk') {
    qtyLabel = '$' + fmtOz(line.qty) + ' FV';
  } else if (isPre33(line.coinType)) {
    qtyLabel = line.qty + ' coins';
  } else if (line.weightUnit && line.weightUnit !== 'ozt') {
    const unitSuffix = line.weightUnit === 'g' ? 'g' : ' ' + WEIGHT_UNITS[line.weightUnit].label;
    qtyLabel = line.rawQty + unitSuffix + ' (' + fmtOz(line.qty) + ' oz)';
  } else {
    qtyLabel = fmtOz(line.qty) + ' oz';
  }
  return `${metalLabel} ${formLabel} â€” ${qtyLabel}`;
}

function addLineToDeal() {
  const metal = $('calcMetal').value;
  const form = $('calcForm').value;
  const coinType = form === 'coins' ? $('calcCoinType').value : null;
  const rawQty = parseFloat($('calcQty').value) || 0;
  if (rawQty <= 0) return;

  const deal = calcDealPrice(metal, form, calcTxType, coinType);
  if (deal.spot <= 0) return;

  let effectiveQty, qty;
  if (form === 'scrap') {
    effectiveQty = getScrapFineOz(rawQty);
    qty = effectiveQty;
  } else if (isPre33(coinType)) {
    effectiveQty = rawQty * (PRE33_GOLD_CONTENT[coinType] || 1);
    qty = rawQty;
  } else {
    const unit = $('calcWeightUnit').value;
    if (unit !== 'ozt' && ['bars', 'rounds', 'coins'].includes(form)) {
      effectiveQty = rawQty * WEIGHT_UNITS[unit].toTroyOz;
    } else {
      effectiveQty = rawQty;
    }
    qty = effectiveQty;
  }

  let pricePerUnit, totalValue, profit;
  if (deal.isJunk) {
    pricePerUnit = deal.pricePerUnit;
    totalValue = pricePerUnit * qty;
    const spotValue = (deal.spot * settings.junkMultiplier) * qty;
    profit = calcTxType === 'sell' ? totalValue - spotValue : spotValue - totalValue;
  } else if (isPre33(coinType)) {
    pricePerUnit = deal.pricePerOz;
    totalValue = pricePerUnit * effectiveQty;
    profit = calcTxType === 'sell' ? (pricePerUnit - deal.spot) * effectiveQty : (deal.spot - pricePerUnit) * effectiveQty;
  } else {
    pricePerUnit = deal.pricePerOz;
    totalValue = pricePerUnit * effectiveQty;
    profit = calcTxType === 'sell' ? (pricePerUnit - deal.spot) * effectiveQty : (deal.spot - pricePerUnit) * effectiveQty;
  }

  const line = {
    metal,
    form,
    coinType: coinType || undefined,
    qty: form === 'scrap' ? effectiveQty : qty,
    spot: deal.spot,
    price: pricePerUnit,
    total: totalValue,
    profit
  };

  if (form === 'scrap') {
    line.scrapPurity = $('scrapPurity').value;
    line.scrapWeightUnit = $('scrapWeightUnit').value;
    line.rawQty = rawQty;
  } else if (['bars', 'rounds', 'coins'].includes(form)) {
    const unit = $('calcWeightUnit').value;
    if (unit !== 'ozt') {
      line.weightUnit = unit;
      line.rawQty = rawQty;
    }
  }

  dealLines.push(line);

  $('calcQty').value = '';
  renderDealLines();
  recalcDeal();
}

function removeLineFromDeal(index) {
  dealLines.splice(index, 1);
  renderDealLines();
  recalcDeal();
}

window.removeLineFromDeal = removeLineFromDeal;

function renderDealLines() {
  const container = $('dealLinesContainer');
  const list = $('dealLinesList');
  const countBadge = $('dealLinesCount');
  const totalEl = $('dealLinesTotal');
  const profitEl = $('dealLinesProfit');

  if (dealLines.length === 0) {
    container.style.display = 'none';
    return;
  }

  container.style.display = 'block';
  countBadge.textContent = dealLines.length;

  list.innerHTML = dealLines.map((line, i) => `
    <div class="deal-line-item">
      <span class="deal-line-desc">${esc(getLineDescription(line))}</span>
      <span class="deal-line-total">${fmt(line.total)}</span>
      <button class="deal-line-remove" onclick="removeLineFromDeal(${i})" title="Remove">&times;</button>
    </div>
  `).join('');

  const combinedTotal = dealLines.reduce((s, l) => s + l.total, 0);
  const combinedProfit = dealLines.reduce((s, l) => s + l.profit, 0);
  totalEl.textContent = fmt(combinedTotal);
  profitEl.textContent = (combinedProfit >= 0 ? '+' : '-') + fmt(combinedProfit);
  profitEl.className = 'profit-value ' + (combinedProfit >= 0 ? 'green' : 'red');
}

// â”€â”€â”€ Deal Calculator â”€â”€â”€
const calcMetal = $('calcMetal');
const calcForm = $('calcForm');
const calcQty = $('calcQty');
const calcPayment = $('calcPayment');
const calcTypeEl = $('calcType');
let calcTxType = 'buy';

// Transaction type segment control
calcTypeEl.querySelectorAll('.segment-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    calcTypeEl.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    calcTxType = btn.dataset.value;
    recalcDeal();
  });
});

// Form select: lock to silver if junk selected, show/hide coin type & scrap groups
calcForm.addEventListener('change', () => {
  if (calcForm.value === 'junk') {
    calcMetal.value = 'silver';
    calcMetal.disabled = true;
  } else if (calcForm.value === 'coins' && $('calcCoinType').value.startsWith('pre33')) {
    calcMetal.value = 'gold';
    calcMetal.disabled = true;
  } else {
    calcMetal.disabled = false;
  }
  $('coinTypeGroup').style.display = calcForm.value === 'coins' ? '' : 'none';
  if (calcForm.value === 'scrap') {
    $('scrapPurityGroup').style.display = '';
    $('scrapWeightUnitGroup').style.display = '';
    $('weightUnitGroup').style.display = 'none';
    populateScrapPurities(calcMetal.value);
  } else {
    $('scrapPurityGroup').style.display = 'none';
    $('scrapWeightUnitGroup').style.display = 'none';
  }
  // Show weight unit for bars, rounds, coins (non-pre33); hide for junk, scrap
  if (['bars', 'rounds'].includes(calcForm.value)) {
    $('weightUnitGroup').style.display = '';
  } else if (calcForm.value === 'coins' && !$('calcCoinType').value.startsWith('pre33')) {
    $('weightUnitGroup').style.display = '';
  } else if (calcForm.value !== 'scrap') {
    $('weightUnitGroup').style.display = 'none';
  }
  $('calcWeightUnit').value = 'ozt';
  updateQtyLabel();
  recalcDeal();
});

$('calcCoinType').addEventListener('change', () => {
  if ($('calcCoinType').value.startsWith('pre33')) {
    calcMetal.value = 'gold';
    calcMetal.disabled = true;
    $('weightUnitGroup').style.display = 'none';
    $('calcWeightUnit').value = 'ozt';
  } else if (calcForm.value !== 'junk') {
    calcMetal.disabled = false;
    $('weightUnitGroup').style.display = '';
  }
  updateQtyLabel();
  recalcDeal();
});

calcMetal.addEventListener('change', () => {
  if (calcForm.value === 'scrap') {
    populateScrapPurities(calcMetal.value);
  }
  recalcDeal();
});
calcQty.addEventListener('input', () => { updateQtyLabel(); recalcDeal(); });
$('scrapPurity').addEventListener('change', () => { updateQtyLabel(); recalcDeal(); });
$('scrapWeightUnit').addEventListener('change', () => { updateQtyLabel(); recalcDeal(); });
$('calcWeightUnit').addEventListener('change', () => { updateQtyLabel(); recalcDeal(); });
calcPayment.addEventListener('change', recalcDeal);

$('addLineBtn').addEventListener('click', addLineToDeal);

function updateQtyLabel() {
  const coinType = calcForm.value === 'coins' ? $('calcCoinType').value : null;
  if (calcForm.value === 'scrap') {
    const qty = parseFloat(calcQty.value) || 0;
    const unit = $('scrapWeightUnit').value;
    const unitLabel = WEIGHT_UNITS[unit].label;
    if (qty > 0) {
      const fineOz = getScrapFineOz(qty);
      $('qtyLabel').textContent = 'Weight (' + fmtOz(fineOz) + ' fine toz)';
    } else {
      $('qtyLabel').textContent = 'Weight (' + unitLabel + ')';
    }
    calcQty.placeholder = unit === 'ozt' ? '0.000' : '0.0';
  } else if (calcForm.value === 'junk') {
    const qty = parseFloat(calcQty.value) || 0;
    const asw = qty * settings.junkMultiplier;
    $('qtyLabel').textContent = qty > 0 ? 'Face Value ($) (' + fmtOz(asw) + ' toz)' : 'Face Value ($)';
    calcQty.placeholder = '0.00';
  } else if (isPre33(coinType)) {
    const qty = parseFloat(calcQty.value) || 0;
    const agw = qty * (PRE33_GOLD_CONTENT[coinType] || 1);
    $('qtyLabel').textContent = qty > 0 ? 'Number of Coins (' + fmtOz(agw) + ' toz)' : 'Number of Coins';
    calcQty.placeholder = '0';
    calcQty.step = '1';
  } else {
    const unit = $('calcWeightUnit').value;
    if (unit !== 'ozt') {
      const qty = parseFloat(calcQty.value) || 0;
      const unitLabel = WEIGHT_UNITS[unit].label;
      if (qty > 0) {
        const troyOz = getWeightInTroyOz(qty);
        $('qtyLabel').textContent = 'Weight (' + fmtOz(troyOz) + ' toz)';
      } else {
        $('qtyLabel').textContent = 'Weight (' + unitLabel + ')';
      }
      calcQty.placeholder = unit === 'g' ? '0.0' : '0.000';
    } else {
      $('qtyLabel').textContent = 'Quantity (Troy Oz)';
      calcQty.placeholder = '0.000';
    }
  }
}

function recalcDeal() {
  const metal = calcMetal.value;
  const form = calcForm.value;
  const coinType = form === 'coins' ? $('calcCoinType').value : null;
  const qty = parseFloat(calcQty.value) || 0;
  const deal = calcDealPrice(metal, form, calcTxType, coinType);

  if (deal.isJunk) {
    $('outSpot').textContent = fmt(deal.spot) + '/oz';
    $('outPriceLabel').textContent = (calcTxType === 'sell' ? 'Our Sell' : 'Our Buy') + ' Multiplier';
    $('outPrice').textContent = deal.pricePerUnit.toFixed(2) + 'x face';

    const spotMultiplier = deal.spot * settings.junkMultiplier;
    const marginPerDollar = Math.abs(deal.pricePerUnit - spotMultiplier);
    $('outMargin').textContent = fmt(marginPerDollar) + ' / $face';

    const totalValue = deal.pricePerUnit * qty;
    $('outTotal').textContent = fmt(totalValue);

    const spotValue = spotMultiplier * qty;
    const profit = calcTxType === 'sell' ? totalValue - spotValue :
                   calcTxType === 'buy' ? spotValue - totalValue :
                   spotValue - totalValue;
    $('outProfit').textContent = (profit >= 0 ? '+' : '-') + fmt(profit);
  } else if (isPre33(coinType)) {
    const goldContent = PRE33_GOLD_CONTENT[coinType] || 1;
    const pricePerCoin = deal.pricePerOz * goldContent;
    const spotPerCoin = deal.spot * goldContent;
    $('outSpot').textContent = fmt(deal.spot) + '/oz';
    $('outPriceLabel').textContent = (calcTxType === 'sell' ? 'Our Sell' : 'Our Buy') + ' Price / coin';
    $('outPrice').textContent = fmt(pricePerCoin);

    const marginPerCoin = Math.abs(pricePerCoin - spotPerCoin);
    $('outMargin').textContent = fmt(marginPerCoin) + ' / coin';

    const effectiveQty = qty * goldContent;
    const totalValue = deal.pricePerOz * effectiveQty;
    $('outTotal').textContent = fmt(totalValue);

    const profit = calcTxType === 'sell' ? (deal.pricePerOz - deal.spot) * effectiveQty :
                   calcTxType === 'buy' ? (deal.spot - deal.pricePerOz) * effectiveQty :
                   (deal.spot - deal.pricePerOz) * effectiveQty;
    $('outProfit').textContent = (profit >= 0 ? '+' : '-') + fmt(profit);
  } else {
    const displayQty = form === 'scrap' ? getScrapFineOz(qty) : (['bars', 'rounds', 'coins'].includes(form) ? getWeightInTroyOz(qty) : qty);
    $('outSpot').textContent = fmt(deal.spot) + '/oz';
    $('outPriceLabel').textContent = (calcTxType === 'sell' ? 'Our Sell' : 'Our Buy') + ' Price / oz';
    $('outPrice').textContent = fmt(deal.pricePerOz);

    const marginPerOz = Math.abs(deal.pricePerOz - deal.spot);
    $('outMargin').textContent = fmt(marginPerOz) + ' / oz';

    const totalValue = deal.pricePerOz * displayQty;
    $('outTotal').textContent = fmt(totalValue);

    const profit = calcTxType === 'sell' ? (deal.pricePerOz - deal.spot) * displayQty :
                   calcTxType === 'buy' ? (deal.spot - deal.pricePerOz) * displayQty :
                   (deal.spot - deal.pricePerOz) * displayQty;
    $('outProfit').textContent = (profit >= 0 ? '+' : '-') + fmt(profit);
  }

  $('addLineBtn').disabled = qty <= 0;
  $('logDealBtn').disabled = dealLines.length === 0 && qty <= 0;

  // Form 8300 compliance warning (single + 24hr aggregation)
  const payment = calcPayment.value;
  const scrapQty = form === 'scrap' ? getScrapFineOz(qty) : (['bars', 'rounds', 'coins'].includes(form) ? getWeightInTroyOz(qty) : qty);
  const pre33Qty = isPre33(coinType) ? qty * (PRE33_GOLD_CONTENT[coinType] || 1) : scrapQty;
  const currentLineTotal = deal.isJunk ? deal.pricePerUnit * qty : (deal.pricePerOz || 0) * pre33Qty;
  const dealLinesTotal = dealLines.reduce((s, l) => s + l.total, 0);
  const totalValue = currentLineTotal + dealLinesTotal;
  const cashWarning = $('cashWarning');
  const customerId = $('selectedCustomerId').value;

  if (payment === 'cash' && (qty > 0 || dealLines.length > 0)) {
    const prior24h = customerId ? get24HourCashTotal(customerId, new Date().toISOString()) : 0;
    const combinedTotal = prior24h + totalValue;

    if (combinedTotal >= 10000) {
      cashWarning.classList.add('visible');
      if (prior24h > 0 && totalValue < 10000) {
        $('cashWarningText').textContent = 'Combined cash from this customer in 24hrs: ' + fmt(combinedTotal) + ' â€” Form 8300 reporting required';
      } else {
        $('cashWarningText').textContent = 'Cash transaction â‰¥ $10,000 â€” Form 8300 reporting required';
      }
      $('cashWarningCustomer').style.display = customerId ? 'none' : 'block';
    } else {
      cashWarning.classList.remove('visible');
    }
  } else {
    cashWarning.classList.remove('visible');
  }

  // 1099-B compliance warning (dealer buy-backs)
  const warning1099B = $('warning1099B');
  if (calcTxType === 'buy' && qty > 0 && is1099BReportableProduct(metal, form, coinType)) {
    const threshold = get1099BThreshold(metal, form, coinType);
    const unit = form === 'junk' ? 'face value' : 'oz';
    const prior24h = customerId ? get24Hour1099BQty(customerId, metal, form, coinType, new Date().toISOString()) : 0;
    const combinedQty = prior24h + qty;

    if (combinedQty >= threshold) {
      warning1099B.classList.add('visible');
      if (prior24h > 0 && qty < threshold) {
        $('warning1099BText').textContent = 'Combined 24hr buy-back qty: ' + combinedQty.toFixed(3) + ' ' + unit + ' (threshold: ' + threshold + ' ' + unit + ') â€” IRS Form 1099-B reporting required';
      } else {
        $('warning1099BText').textContent = 'Buy-back of ' + qty + ' ' + unit + ' meets ' + threshold + ' ' + unit + ' threshold â€” IRS Form 1099-B reporting required';
      }
      // W-9 warning
      if (customerId) {
        const cust = customers.find(c => c.id === customerId);
        $('warning1099BW9').style.display = (cust && !cust.w9OnFile) ? 'block' : 'none';
      } else {
        $('warning1099BW9').style.display = 'block';
        $('warning1099BW9').textContent = 'Customer required â€” W-9 must be on file for 1099-B reporting';
      }
    } else {
      warning1099B.classList.remove('visible');
    }
  } else {
    warning1099B.classList.remove('visible');
  }
}

// â”€â”€â”€ Log Deal â”€â”€â”€
$('logDealBtn').addEventListener('click', () => {
  // If current form has a qty, add it as a line first
  const currentQty = parseFloat(calcQty.value) || 0;
  if (currentQty > 0) {
    addLineToDeal();
  }

  if (dealLines.length === 0) return;

  const combinedTotal = dealLines.reduce((s, l) => s + l.total, 0);
  const combinedProfit = dealLines.reduce((s, l) => s + l.profit, 0);

  if (combinedTotal <= 0) { alert('Calculated total value is invalid.'); return; }

  // Check spot price on first line
  if (dealLines[0].spot <= 0) { alert('Spot price is not loaded or invalid.'); return; }

  const selectedCustomerIdInput = $('selectedCustomerId');
  const tx = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    date: new Date().toISOString(),
    type: calcTxType,
    total: combinedTotal,
    payment: calcPayment.value,
    profit: combinedProfit,
    customerId: selectedCustomerIdInput.value || undefined,
    notes: $('calcNotes').value.trim() || undefined,
    lines: [...dealLines]
  };

  // For backward compat: copy flat fields from single-line deals
  if (dealLines.length === 1) {
    tx.metal = dealLines[0].metal;
    tx.form = dealLines[0].form;
    tx.coinType = dealLines[0].coinType;
    tx.qty = dealLines[0].qty;
    tx.spot = dealLines[0].spot;
    tx.price = dealLines[0].price;
    if (dealLines[0].scrapPurity) {
      tx.scrapPurity = dealLines[0].scrapPurity;
      tx.scrapWeightUnit = dealLines[0].scrapWeightUnit;
      tx.rawQty = dealLines[0].rawQty;
    }
    if (dealLines[0].weightUnit) {
      tx.weightUnit = dealLines[0].weightUnit;
      tx.rawQty = dealLines[0].rawQty;
    }
  }

  // Form 8300 compliance flag (single transaction)
  if (tx.payment === 'cash' && tx.total >= 10000) {
    tx.form8300Flag = true;
  }

  // Form 8300 24-hour aggregation flag
  if (tx.payment === 'cash' && tx.customerId && tx.total > 0) {
    const prior24h = get24HourCashTotal(tx.customerId, tx.date);
    if (prior24h + tx.total >= 10000) {
      tx.form8300Flag = true;
      // Flag all related cash transactions in the 24hr window
      transactions.forEach(t => {
        if (t.customerId === tx.customerId && t.payment === 'cash' && t.total > 0 &&
            Math.abs(new Date(t.date).getTime() - new Date(tx.date).getTime()) <= 86400000) {
          t.form8300Flag = true;
        }
      });
    }
  }

  // 1099-B compliance flag â€” check per line
  tx.lines.forEach(line => {
    const pseudoTx = { type: tx.type, metal: line.metal, form: line.form, coinType: line.coinType, qty: line.qty, customerId: tx.customerId, date: tx.date };
    const result1099B = check1099B(pseudoTx);
    if (result1099B.reportable) {
      tx.form1099BFlag = true;
      // Retroactively flag related buy transactions in 24hr window
      if (tx.customerId) {
        const key = get1099BProductKey(line.metal, line.form, line.coinType);
        transactions.forEach(t => {
          if (t.customerId === tx.customerId && t.type === 'buy' &&
              Math.abs(new Date(t.date).getTime() - new Date(tx.date).getTime()) <= 86400000) {
            getTxLines(t).forEach(tl => {
              if (get1099BProductKey(tl.metal, tl.form, tl.coinType) === key) {
                t.form1099BFlag = true;
              }
            });
          }
        });
      }
    }
  });

  transactions.unshift(tx);
  Store.set('transactions', transactions);

  // Flash success message
  const msg = $('dealLoggedMsg');
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 2000);

  // Show receipt
  showReceipt(tx.id);

  // Reset dealLines, qty, notes, and customer
  dealLines = [];
  renderDealLines();
  calcQty.value = '';
  $('calcNotes').value = '';
  clearCustomer();
  recalcDeal();
  checkAlerts();
  updateDashboard();
});

// â”€â”€â”€ Transaction Log â”€â”€â”€
let sortField = 'date';
let sortDir = -1; // -1 = desc

function getFilteredTransactions() {
  let list = [...transactions];
  const from = $('filterFrom').value;
  const to = $('filterTo').value;
  const metal = $('filterMetal').value;
  const form = $('filterForm').value;
  const type = $('filterType').value;
  const customerId = $('filterCustomer').value;
  const compliance = $('filterCompliance').value;

  if (from) list = list.filter(t => t.date >= from);
  if (to) list = list.filter(t => t.date <= to + 'T23:59:59');
  if (metal) list = list.filter(t => getTxLines(t).some(l => l.metal === metal));
  if (form) list = list.filter(t => getTxLines(t).some(l => l.form === form));
  if (type) list = list.filter(t => t.type === type);
  if (customerId) list = list.filter(t => t.customerId === customerId);
  if (compliance === 'flagged') list = list.filter(t => t.form8300Flag);
  else if (compliance === 'needs-review') list = list.filter(t => t.form8300Flag && !t.form8300Reviewed);
  else if (compliance === 'reviewed') list = list.filter(t => t.form8300Flag && t.form8300Reviewed);
  else if (compliance === '1099b-flagged') list = list.filter(t => t.form1099BFlag);
  else if (compliance === '1099b-needs-filing') list = list.filter(t => t.form1099BFlag && !t.form1099BFiled);
  else if (compliance === '1099b-filed') list = list.filter(t => t.form1099BFlag && t.form1099BFiled);
  else if (compliance === 'any-compliance') list = list.filter(t => t.form8300Flag || t.form1099BFlag);

  list.sort((a, b) => {
    let va, vb;
    if (sortField === 'date') { va = a.date; vb = b.date; }
    else if (sortField === 'total') { va = a.total; vb = b.total; }
    else if (sortField === 'profit') { va = a.profit; vb = b.profit; }
    else { va = a[sortField]; vb = b[sortField]; }
    if (va < vb) return -1 * sortDir;
    if (va > vb) return 1 * sortDir;
    return 0;
  });

  return list;
}

function renderTransactions() {
  const list = getFilteredTransactions();
  const tbody = $('txBody');
  const empty = $('txEmpty');

  if (list.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';
  tbody.innerHTML = list.map(tx => {
    const d = new Date(tx.date);
    const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                    d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const typeClass = tx.type === 'buy' ? 'buy' : tx.type === 'sell' ? 'sell' : 'wholesale';
    const profitClass = tx.profit >= 0 ? 'profit-positive' : 'profit-negative';

    const lines = getTxLines(tx);
    const isMulti = lines.length > 1;
    let metalCol, formCol, qtyLabel, spotCol, priceCol;

    if (isMulti) {
      const metals = [...new Set(lines.map(l => l.metal))];
      metalCol = metals.map(m => m === 'gold' ? '<span style="color:var(--gold)">Au</span>' : '<span style="color:var(--silver)">Ag</span>').join('+');
      formCol = lines.length + ' items';
      qtyLabel = lines.map(l => l.form === 'junk' ? '$' + fmtOz(l.qty) + ' FV' : isPre33(l.coinType) ? l.qty + ' coins' : l.form === 'scrap' && l.scrapPurity ? fmtOz(l.qty) + ' fine oz' : fmtOz(l.qty)).join(', ');
      spotCol = 'â€”';
      priceCol = 'â€”';
    } else {
      const line = lines[0];
      metalCol = line.metal === 'gold' ? '<span style="color:var(--gold)">Gold</span>' : '<span style="color:var(--silver)">Silver</span>';
      formCol = getFormDisplayLabel(line.form, line.coinType);
      qtyLabel = line.form === 'junk' ? '$' + fmtOz(line.qty) + ' FV' : isPre33(line.coinType) ? line.qty + ' coins' : line.form === 'scrap' && line.scrapPurity ? fmtOz(line.qty) + ' fine oz' : line.weightUnit && line.weightUnit !== 'ozt' ? line.rawQty + (line.weightUnit === 'g' ? 'g' : ' ' + WEIGHT_UNITS[line.weightUnit].label) + ' (' + fmtOz(line.qty) + ' oz)' : fmtOz(line.qty) + ' oz';
      spotCol = fmt(line.spot);
      priceCol = fmt(line.price);
    }

    const badge8300 = tx.form8300Flag ? '<span class="compliance-badge">8300</span>' : '';
    const badge1099B = tx.form1099BFlag ? '<span class="compliance-badge-1099b">1099-B</span>' : '';
    const flagBadge = badge8300 + badge1099B;
    const rowClasses = [];
    if (tx.form8300Flag) rowClasses.push('compliance-row-flagged');
    if (tx.form1099BFlag) rowClasses.push('compliance-row-1099b');
    const rowClass = rowClasses.length ? ` class="${rowClasses.join(' ')}"` : '';

    return `<tr${rowClass}>
      <td class="mono">${dateStr}</td>
      <td>${metalCol}</td>
      <td>${formCol}</td>
      <td><span class="type-badge ${typeClass}">${getTypeLabel(tx.type)}</span></td>
      <td>${tx.customerId && getCustomerName(tx.customerId) ? '<a href="#" onclick="openCustomerProfile(\'' + esc(tx.customerId) + '\');return false;" style="color:var(--gold);text-decoration:none;">' + esc(getCustomerName(tx.customerId)) + '</a>' : 'â€”'}</td>
      <td class="mono">${qtyLabel}</td>
      <td class="mono">${spotCol}</td>
      <td class="mono">${priceCol}</td>
      <td class="mono">${fmt(tx.total)}${flagBadge}</td>
      <td>${tx.payment === 'cash' ? 'Cash' : tx.payment === 'wire' ? 'Wire' : 'Check'}</td>
      <td class="${profitClass}">${(tx.profit >= 0 ? '+' : '-') + fmt(tx.profit)}</td>
      <td class="row-actions">
        <button class="row-action-btn" onclick="showReceipt('${tx.id}')" title="Receipt">ğŸ§¾</button>
        <button class="row-action-btn" onclick="openEditModal('${tx.id}')" title="Edit">âœï¸</button>
        <button class="row-action-btn" onclick="openDeleteModal('${tx.id}')" title="Delete">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  }).join('');
}

// Sort headers
document.querySelectorAll('th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const field = th.dataset.sort;
    if (sortField === field) sortDir *= -1;
    else { sortField = field; sortDir = -1; }
    renderTransactions();
  });
});

// Filters
['filterFrom', 'filterTo', 'filterMetal', 'filterForm', 'filterType', 'filterCustomer', 'filterCompliance'].forEach(id => {
  $(id).addEventListener('change', renderTransactions);
});

$('clearFiltersBtn').addEventListener('click', () => {
  $('filterFrom').value = '';
  $('filterTo').value = '';
  $('filterMetal').value = '';
  $('filterForm').value = '';
  $('filterType').value = '';
  $('filterCustomer').value = '';
  $('filterCompliance').value = '';
  renderTransactions();
});

// Export CSV
$('exportCsvBtn').addEventListener('click', () => {
  const list = getFilteredTransactions();
  if (list.length === 0) return;

  const headers = ['Deal ID', 'Date', 'Metal', 'Form', 'Coin Type', 'Type', 'Customer', 'Quantity', 'Spot Price', 'Our Price', 'Total', 'Payment', 'Profit', 'Form 8300', '1099-B', 'Notes'];
  const rows = [];
  list.forEach(tx => {
    const lines = getTxLines(tx);
    lines.forEach(line => {
      rows.push([
        tx.id,
        new Date(tx.date).toLocaleString(),
        line.metal, getFormLabel(line.form), line.coinType ? getCoinTypeLabel(line.coinType) : '',
        getTypeLabel(tx.type),
        getCustomerName(tx.customerId),
        line.qty, line.spot, line.price, line.total, tx.payment, line.profit,
        tx.form8300Flag ? (tx.form8300Reviewed ? 'Reviewed' : 'Flagged') : '',
        tx.form1099BFlag ? (tx.form1099BFiled ? 'Filed' : 'Flagged') : '',
        tx.notes || ''
      ]);
    });
  });

  const csv = [headers, ...rows].map(r => r.map(v => `"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `stacktrack-transactions-${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

// Edit Modal
window.openEditModal = function(id) {
  const tx = transactions.find(t => t.id === id);
  if (!tx) return;
  const lines = getTxLines(tx);
  const line = lines[0];
  $('editTxId').value = id;
  $('editMetal').value = line.metal;
  $('editForm').value = line.form;
  $('editCoinTypeGroup').style.display = line.form === 'coins' ? '' : 'none';
  $('editCoinType').value = line.coinType || '';
  // Scrap purity fields
  if (line.form === 'scrap' && line.scrapPurity) {
    $('editScrapPurityGroup').style.display = '';
    $('editScrapWeightUnitGroup').style.display = '';
    const editPuritySel = $('editScrapPurity');
    const purities = SCRAP_PURITIES[line.metal] || {};
    editPuritySel.innerHTML = Object.entries(purities).map(([key, p]) =>
      `<option value="${key}">${p.label}</option>`
    ).join('');
    editPuritySel.value = line.scrapPurity;
    $('editScrapWeightUnit').value = line.scrapWeightUnit || 'ozt';
    $('editQty').value = line.rawQty;
  } else {
    $('editScrapPurityGroup').style.display = 'none';
    $('editScrapWeightUnitGroup').style.display = 'none';
  }
  // Weight unit for bars/rounds/coins
  if (line.weightUnit && ['bars', 'rounds', 'coins'].includes(line.form) && !isPre33(line.coinType)) {
    $('editWeightUnitGroup').style.display = '';
    $('editWeightUnit').value = line.weightUnit;
    $('editQty').value = line.rawQty;
  } else if (['bars', 'rounds'].includes(line.form) || (line.form === 'coins' && !isPre33(line.coinType))) {
    $('editWeightUnitGroup').style.display = '';
    $('editWeightUnit').value = 'ozt';
  } else {
    $('editWeightUnitGroup').style.display = 'none';
    $('editWeightUnit').value = 'ozt';
  }
  $('editType').value = tx.type;
  if (!(line.form === 'scrap' && line.scrapPurity)) $('editQty').value = line.qty;
  $('editSpot').value = line.spot;
  $('editPrice').value = line.price;
  $('editPayment').value = tx.payment;
  $('editNotes').value = tx.notes || '';
  populateEditCustomerSelect();
  $('editCustomer').value = tx.customerId || '';
  // Form 8300 review toggle
  if (tx.form8300Flag) {
    $('editForm8300Group').style.display = '';
    $('editForm8300Reviewed').checked = !!tx.form8300Reviewed;
  } else {
    $('editForm8300Group').style.display = 'none';
    $('editForm8300Reviewed').checked = false;
  }
  // 1099-B filed toggle
  if (tx.form1099BFlag) {
    $('editForm1099BGroup').style.display = '';
    $('editForm1099BFiled').checked = !!tx.form1099BFiled;
  } else {
    $('editForm1099BGroup').style.display = 'none';
    $('editForm1099BFiled').checked = false;
  }
  $('editModal').classList.add('open');
};

$('editForm').addEventListener('change', () => {
  $('editCoinTypeGroup').style.display = $('editForm').value === 'coins' ? '' : 'none';
  $('editScrapPurityGroup').style.display = $('editForm').value === 'scrap' ? '' : 'none';
  $('editScrapWeightUnitGroup').style.display = $('editForm').value === 'scrap' ? '' : 'none';
  // Weight unit for bars/rounds/coins (non-pre33)
  const editFormVal = $('editForm').value;
  if (['bars', 'rounds'].includes(editFormVal) || (editFormVal === 'coins' && !($('editCoinType').value || '').startsWith('pre33'))) {
    $('editWeightUnitGroup').style.display = '';
  } else {
    $('editWeightUnitGroup').style.display = 'none';
    $('editWeightUnit').value = 'ozt';
  }
  if ($('editForm').value === 'scrap' && !$('editScrapPurity').options.length) {
    const metal = $('editMetal').value;
    const purities = SCRAP_PURITIES[metal] || {};
    $('editScrapPurity').innerHTML = Object.entries(purities).map(([key, p]) =>
      `<option value="${key}">${p.label}</option>`
    ).join('');
    if (metal === 'gold') $('editScrapPurity').value = '14k';
    else if (metal === 'silver') $('editScrapPurity').value = '925';
  }
});

$('editCancelBtn').addEventListener('click', () => $('editModal').classList.remove('open'));

$('editSaveBtn').addEventListener('click', () => {
  const id = $('editTxId').value;
  const idx = transactions.findIndex(t => t.id === id);
  if (idx === -1) return;

  const rawQtyInput = parseFloat($('editQty').value) || 0;
  const spot = parseFloat($('editSpot').value) || 0;
  const price = parseFloat($('editPrice').value) || 0;
  const type = $('editType').value;
  const editedForm = $('editForm').value;
  const editedMetal = $('editMetal').value;

  if (rawQtyInput <= 0) { alert('Quantity must be greater than 0.'); return; }
  if (spot <= 0) { alert('Spot price must be greater than 0.'); return; }
  if (price <= 0) { alert('Price must be greater than 0.'); return; }

  // Scrap purity conversion
  let qty = rawQtyInput;
  let editScrapPurity, editScrapWeightUnit, editRawQty;
  let editWeightUnit, editWeightRawQty;
  if (editedForm === 'scrap' && $('editScrapPurityGroup').style.display !== 'none') {
    const purityKey = $('editScrapPurity').value;
    const unitKey = $('editScrapWeightUnit').value;
    const purity = (SCRAP_PURITIES[editedMetal] || {})[purityKey];
    if (purity) {
      qty = rawQtyInput * WEIGHT_UNITS[unitKey].toTroyOz * purity.fineness;
      editScrapPurity = purityKey;
      editScrapWeightUnit = unitKey;
      editRawQty = rawQtyInput;
    }
  } else if (['bars', 'rounds', 'coins'].includes(editedForm) && $('editWeightUnitGroup').style.display !== 'none') {
    const unitKey = $('editWeightUnit').value;
    if (unitKey !== 'ozt') {
      qty = rawQtyInput * WEIGHT_UNITS[unitKey].toTroyOz;
      editWeightUnit = unitKey;
      editWeightRawQty = rawQtyInput;
    }
  }

  const total = price * qty;
  const profit = type === 'sell' ? (price - spot) * qty : (spot - price) * qty;

  const editedCoinType = editedForm === 'coins' ? ($('editCoinType').value || undefined) : undefined;

  const editedCustomerId = $('editCustomer').value || undefined;

  const editedPayment = $('editPayment').value;
  const txDate = transactions[idx].date;
  const txId = transactions[idx].id;
  let editedFlag = (editedPayment === 'cash' && total >= 10000);
  // 24-hour aggregation check on edit
  if (!editedFlag && editedPayment === 'cash' && editedCustomerId && total > 0) {
    const prior24h = get24HourCashTotal(editedCustomerId, txDate, txId);
    if (prior24h + total >= 10000) editedFlag = true;
  }
  const existingFlag = transactions[idx].form8300Flag;

  // 1099-B recalculation on edit
  const edited1099BTx = {
    type,
    metal: editedMetal,
    form: editedForm,
    coinType: editedCoinType,
    qty,
    customerId: editedCustomerId,
    date: txDate
  };
  const result1099B = check1099B(edited1099BTx, txId);
  const edited1099BFlag = result1099B.reportable;
  const existing1099BFlag = transactions[idx].form1099BFlag;

  const existingLines = transactions[idx].lines;
  const updatedLine = { metal: editedMetal, form: editedForm, coinType: editedCoinType, qty, spot, price, total, profit };
  if (editScrapPurity) {
    updatedLine.scrapPurity = editScrapPurity;
    updatedLine.scrapWeightUnit = editScrapWeightUnit;
    updatedLine.rawQty = editRawQty;
  }
  if (editWeightUnit) {
    updatedLine.weightUnit = editWeightUnit;
    updatedLine.rawQty = editWeightRawQty;
  }

  if (existingLines && existingLines.length > 1) {
    // Multi-line: update first line, recompute deal totals
    existingLines[0] = updatedLine;
    const dealTotal = existingLines.reduce((s, l) => s + l.total, 0);
    const dealProfit = existingLines.reduce((s, l) => s + l.profit, 0);
    // Recalculate 8300 flag with new deal total
    editedFlag = (editedPayment === 'cash' && dealTotal >= 10000);
    if (!editedFlag && editedPayment === 'cash' && editedCustomerId && dealTotal > 0) {
      const prior24h = get24HourCashTotal(editedCustomerId, txDate, txId);
      if (prior24h + dealTotal >= 10000) editedFlag = true;
    }

    transactions[idx] = {
      ...transactions[idx],
      type,
      total: dealTotal,
      payment: editedPayment,
      profit: dealProfit,
      customerId: editedCustomerId,
      notes: $('editNotes').value.trim() || undefined,
      form8300Flag: editedFlag || undefined,
      form8300Reviewed: editedFlag && existingFlag ? $('editForm8300Reviewed').checked : undefined,
      form1099BFlag: edited1099BFlag || undefined,
      form1099BFiled: edited1099BFlag && existing1099BFlag ? $('editForm1099BFiled').checked : undefined,
      lines: existingLines
    };
  } else {
    const updated = {
      ...transactions[idx],
      metal: editedMetal,
      form: editedForm,
      coinType: editedCoinType,
      type,
      qty, spot, price, total,
      payment: editedPayment,
      profit,
      customerId: editedCustomerId,
      notes: $('editNotes').value.trim() || undefined,
      form8300Flag: editedFlag || undefined,
      form8300Reviewed: editedFlag && existingFlag ? $('editForm8300Reviewed').checked : undefined,
      form1099BFlag: edited1099BFlag || undefined,
      form1099BFiled: edited1099BFlag && existing1099BFlag ? $('editForm1099BFiled').checked : undefined,
      lines: [updatedLine]
    };
    if (editScrapPurity) {
      updated.scrapPurity = editScrapPurity;
      updated.scrapWeightUnit = editScrapWeightUnit;
      updated.rawQty = editRawQty;
    } else {
      delete updated.scrapPurity;
      delete updated.scrapWeightUnit;
    }
    if (editWeightUnit) {
      updated.weightUnit = editWeightUnit;
      updated.rawQty = editWeightRawQty;
    } else if (!editScrapPurity) {
      delete updated.weightUnit;
      delete updated.rawQty;
    }
    transactions[idx] = updated;
  }

  Store.set('transactions', transactions);
  $('editModal').classList.remove('open');
  renderTransactions();
  checkAlerts();
  updateDashboard();
});

// Delete Modal
window.openDeleteModal = function(id) {
  $('deleteTxId').value = id;
  $('deleteModal').classList.add('open');
};

$('deleteCancelBtn').addEventListener('click', () => $('deleteModal').classList.remove('open'));

$('deleteConfirmBtn').addEventListener('click', () => {
  const id = $('deleteTxId').value;
  transactions = transactions.filter(t => t.id !== id);
  Store.set('transactions', transactions);
  $('deleteModal').classList.remove('open');
  renderTransactions();
  checkAlerts();
  updateDashboard();
});

// Close modals on overlay click
['editModal', 'deleteModal', 'receiptModal', 'addCustomerModal'].forEach(id => {
  $(id).addEventListener('click', (e) => {
    if (e.target === $(id)) $(id).classList.remove('open');
  });
});

// Close modals on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    ['editModal', 'deleteModal', 'receiptModal', 'addCustomerModal', 'customerProfileOverlay'].forEach(id => {
      $(id).classList.remove('open');
    });
  }
});

// â”€â”€â”€ Receipt â”€â”€â”€
function generateReceipt(tx) {
  const d = new Date(tx.date);
  const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
  const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  const paymentLabel = tx.payment === 'cash' ? 'Cash' : tx.payment === 'wire' ? 'Bank Wire' : 'Check';
  const typeLabel = tx.type === 'buy' ? 'PURCHASE FROM CUSTOMER' : tx.type === 'sell' ? 'SALE TO CUSTOMER' : 'WHOLESALE';
  const txId = tx.id.toUpperCase().slice(0, 10);
  const lines = getTxLines(tx);
  const isMulti = lines.length > 1;

  let itemsHtml;
  if (isMulti) {
    itemsHtml = `<div class="receipt-body">` +
      lines.map((line, i) => {
        const metalLabel = line.metal === 'gold' ? 'Gold' : 'Silver';
        const qtyLabel = line.form === 'junk' ? '$' + fmtOz(line.qty) + ' FV' : isPre33(line.coinType) ? line.qty + ' coins' : line.form === 'scrap' && line.scrapPurity ? line.rawQty + (line.scrapWeightUnit === 'g' ? 'g' : line.scrapWeightUnit === 'dwt' ? ' dwt' : line.scrapWeightUnit === 'tlb' ? ' tlb' : ' ozt') + ' ' + ((SCRAP_PURITIES[line.metal] || {})[line.scrapPurity] || {}).label + ' (' + fmtOz(line.qty) + ' fine toz)' : line.weightUnit && line.weightUnit !== 'ozt' ? line.rawQty + (line.weightUnit === 'g' ? 'g' : ' ' + WEIGHT_UNITS[line.weightUnit].label) + ' (' + fmtOz(line.qty) + ' troy oz)' : fmtOz(line.qty) + ' oz';
        return `
          <div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px dotted #ddd;">
            <div style="font-weight:700;font-size:12px;color:#888;margin-bottom:4px;">Item ${i + 1}</div>
            <div class="receipt-row"><span class="receipt-label">Metal</span><span class="receipt-val">${metalLabel}</span></div>
            <div class="receipt-row"><span class="receipt-label">Form</span><span class="receipt-val">${getFormDisplayLabel(line.form, line.coinType)}</span></div>
            <div class="receipt-row"><span class="receipt-label">Quantity</span><span class="receipt-val">${qtyLabel}</span></div>
            <div class="receipt-row"><span class="receipt-label">Price</span><span class="receipt-val">${line.form === 'junk' ? line.price.toFixed(2) + 'x face' : isPre33(line.coinType) ? fmt(line.price * (PRE33_GOLD_CONTENT[line.coinType] || 1)) + ' / coin' : fmt(line.price) + ' / oz'}</span></div>
            <div class="receipt-row"><span class="receipt-label">Subtotal</span><span class="receipt-val">${fmt(line.total)}</span></div>
          </div>`;
      }).join('') +
      `<div class="receipt-row"><span class="receipt-label">Payment Method</span><span class="receipt-val">${paymentLabel}</span></div>
      </div>`;
  } else {
    const line = lines[0];
    const metalLabel = line.metal === 'gold' ? 'Gold' : 'Silver';
    const qtyLabel = line.form === 'junk' ? '$' + fmtOz(line.qty) + ' Face Value' : isPre33(line.coinType) ? line.qty + ' coins' : line.form === 'scrap' && line.scrapPurity ? line.rawQty + (line.scrapWeightUnit === 'g' ? 'g' : line.scrapWeightUnit === 'dwt' ? ' dwt' : line.scrapWeightUnit === 'tlb' ? ' tlb' : ' ozt') + ' ' + ((SCRAP_PURITIES[line.metal] || {})[line.scrapPurity] || {}).label + ' (' + fmtOz(line.qty) + ' fine toz)' : line.weightUnit && line.weightUnit !== 'ozt' ? line.rawQty + (line.weightUnit === 'g' ? 'g' : ' ' + WEIGHT_UNITS[line.weightUnit].label) + ' (' + fmtOz(line.qty) + ' troy oz)' : fmtOz(line.qty) + ' troy oz';
    itemsHtml = `
    <div class="receipt-body">
      <div class="receipt-row"><span class="receipt-label">Metal</span><span class="receipt-val">${metalLabel}</span></div>
      <div class="receipt-row"><span class="receipt-label">Form</span><span class="receipt-val">${getFormDisplayLabel(line.form, line.coinType)}</span></div>
      <div class="receipt-row"><span class="receipt-label">Quantity</span><span class="receipt-val">${qtyLabel}</span></div>
      <div class="receipt-row"><span class="receipt-label">Spot Price</span><span class="receipt-val">${fmt(line.spot)} / oz</span></div>
      <div class="receipt-row"><span class="receipt-label">${tx.type === 'sell' ? 'Sale' : 'Buy'} Price</span><span class="receipt-val">${line.form === 'junk' ? line.price.toFixed(2) + 'x face' : isPre33(line.coinType) ? fmt(line.price * (PRE33_GOLD_CONTENT[line.coinType] || 1)) + ' / coin' : fmt(line.price) + ' / oz'}</span></div>
      <div class="receipt-row"><span class="receipt-label">Payment Method</span><span class="receipt-val">${paymentLabel}</span></div>
    </div>`;
  }

  return `
    <div class="receipt-header">
      <div class="receipt-shop-name">${esc(settings.shopName)}</div>
      <div class="receipt-subtitle">Bullion Transaction Receipt</div>
      <div class="receipt-date">${dateStr} at ${timeStr}</div>
      <div style="font-size:10px;color:#aaa;margin-top:4px;">Ref# ${txId}</div>
    </div>
    ${tx.customerId ? `<div style="text-align:center;margin-bottom:12px;font-size:13px;color:#444;">Customer: <strong>${esc(getCustomerName(tx.customerId))}</strong></div>` : ''}
    <div style="text-align:center;margin-bottom:16px;">
      <span style="background:#f0f0f0;padding:4px 12px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:1px;">${typeLabel}</span>
    </div>
    ${itemsHtml}
    <div class="receipt-total">
      <div class="receipt-total-label">Total Amount</div>
      <div class="receipt-total-value">${fmt(tx.total)}${tx.form8300Flag ? '<span class="compliance-indicator"></span>' : ''}</div>
    </div>
    ${tx.form8300Flag ? `<div style="background:#fff3e0;border:1px solid #FFB300;border-radius:4px;padding:8px 10px;font-size:11px;color:#8d6e00;text-align:center;margin-bottom:12px;font-weight:600;">NOTICE: This cash transaction meets the $10,000 threshold for IRS Form 8300 reporting.</div>` : ''}
    ${tx.form1099BFlag ? `<div style="background:#e3f2fd;border:1px solid #2196F3;border-radius:4px;padding:8px 10px;font-size:11px;color:#1565C0;text-align:center;margin-bottom:12px;font-weight:600;">NOTICE: This buy-back transaction is reportable under IRS Form 1099-B. A W-9 is required from the seller.</div>` : ''}
    <div class="receipt-footer">
      Thank you for your business!<br>
      Powered by StackTrack
    </div>
  `;
}

function showReceipt(txId) {
  const tx = transactions.find(t => t.id === txId);
  if (!tx) return;
  $('receiptContent').innerHTML = generateReceipt(tx);
  $('receiptModal').classList.add('open');
}

window.showReceipt = showReceipt;

$('receiptCloseBtn').addEventListener('click', () => $('receiptModal').classList.remove('open'));

$('receiptPrintBtn').addEventListener('click', () => {
  // Move receipt content to body level for print
  const printWindow = window.open('', '_blank', 'width=420,height=600');
  printWindow.document.write(`<!DOCTYPE html><html><head><title>Receipt</title>
    <style>
      body { font-family: 'SF Mono','Fira Code','Consolas',monospace; margin: 0; padding: 20px; color: #111; }
      .receipt-header { text-align: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px dashed #ccc; }
      .receipt-shop-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
      .receipt-subtitle { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
      .receipt-date { font-size: 12px; color: #666; margin-top: 8px; }
      .receipt-body { margin-bottom: 20px; }
      .receipt-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dotted #ddd; }
      .receipt-row:last-child { border-bottom: none; }
      .receipt-label { color: #666; font-size: 12px; }
      .receipt-val { font-weight: 700; color: #111; font-size: 13px; }
      .receipt-total { text-align: center; margin: 20px 0; padding: 16px 0; border-top: 2px dashed #ccc; border-bottom: 2px dashed #ccc; }
      .receipt-total-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
      .receipt-total-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
      .receipt-footer { text-align: center; font-size: 11px; color: #aaa; margin-top: 16px; }
    </style></head><body>${$('receiptContent').innerHTML}</body></html>`);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
});

// â”€â”€â”€ Inventory â”€â”€â”€
function getInventory() {
  const inv = { gold: {}, silver: {} };
  const forms = ['coins', 'bars', 'rounds', 'junk', 'scrap'];
  forms.forEach(f => { inv.gold[f] = 0; inv.silver[f] = 0; });

  transactions.forEach(tx => {
    getTxLines(tx).forEach(line => {
      const metal = line.metal;
      const qty = line.form === 'junk' ? line.qty * settings.junkMultiplier
                : isPre33(line.coinType) ? line.qty * (PRE33_GOLD_CONTENT[line.coinType] || 1)
                : line.qty;
      if (tx.type === 'buy') {
        inv[metal][line.form] += qty;
      } else {
        inv[metal][line.form] -= qty;
      }
    });
  });

  const totalGold = Object.values(inv.gold).reduce((s, v) => s + v, 0);
  const totalSilver = Object.values(inv.silver).reduce((s, v) => s + v, 0);

  return { inv, totalGold, totalSilver };
}

function updateInventoryPage() {
  const { inv, totalGold, totalSilver } = getInventory();

  $('invGoldOz').textContent = (totalGold < 0 ? '-' : '') + fmtOz(Math.abs(totalGold));
  $('invSilverOz').textContent = (totalSilver < 0 ? '-' : '') + fmtOz(Math.abs(totalSilver));
  $('invGoldOz').style.color = totalGold < 0 ? 'var(--red)' : '';
  $('invSilverOz').style.color = totalSilver < 0 ? 'var(--red)' : '';
  $('invGoldValue').textContent = (totalGold < 0 ? '-' : '') + fmt(totalGold * spotPrices.gold) + ' at spot';
  $('invSilverValue').textContent = (totalSilver < 0 ? '-' : '') + fmt(totalSilver * spotPrices.silver) + ' at spot';

  // Breakdowns with low-stock indicators
  const forms = ['coins', 'bars', 'rounds', 'junk', 'scrap'];
  const rp = settings.reorderPoints || {};
  const reorderAlerts = [];

  const renderBreakdown = (metalInv, metal) => forms
    .filter(f => metalInv[f] !== 0)
    .map(f => {
      const key = metal + f.charAt(0).toUpperCase() + f.slice(1);
      const threshold = rp[key] || 0;
      const isLow = threshold > 0 && metalInv[f] < threshold;
      if (isLow) {
        reorderAlerts.push({ metal, form: f, current: metalInv[f], threshold });
      }
      return `<div class="breakdown-row${isLow ? ' low-stock' : ''}"><span>${isLow ? '<span class="reorder-dot"></span>' : ''}${getFormLabel(f)}</span><span class="breakdown-val">${fmtOz(metalInv[f])} oz</span></div>`;
    })
    .join('');

  $('invGoldBreakdown').innerHTML = renderBreakdown(inv.gold, 'gold');
  $('invSilverBreakdown').innerHTML = renderBreakdown(inv.silver, 'silver');

  // Reorder alerts card
  const alertList = $('invReorderList');
  const alertEmpty = $('invReorderEmpty');
  if (reorderAlerts.length > 0) {
    alertList.innerHTML = reorderAlerts.map(a =>
      `<div class="reorder-alert-item"><span class="reorder-dot"></span>${a.metal.charAt(0).toUpperCase() + a.metal.slice(1)} ${getFormLabel(a.form)}: ${fmtOz(a.current)} oz (reorder point: ${fmtOz(a.threshold)} oz)</div>`
    ).join('');
    alertEmpty.style.display = 'none';
  } else {
    alertList.innerHTML = '';
    alertEmpty.style.display = 'block';
  }
}

// â”€â”€â”€ Wholesale Contacts â”€â”€â”€
function renderContacts() {
  const list = $('contactsList');
  const empty = $('contactsEmpty');

  if (contacts.length === 0) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';
  list.innerHTML = contacts.map((c, i) => `
    <div class="contact-row">
      <span class="contact-name">${esc(c.name)}</span>
      <span class="contact-company">${esc(c.company)}</span>
      <span class="contact-phone">${esc(c.phone)}</span>
      <span style="color:var(--text-muted);font-size:12px;flex:1;">${esc(c.notes || '')}</span>
      <button class="row-action-btn" onclick="deleteContact(${i})" title="Remove">ğŸ—‘ï¸</button>
    </div>
  `).join('');
}

$('addContactBtn').addEventListener('click', () => {
  const name = $('contactName').value.trim();
  if (!name) return;

  contacts.push({
    name,
    company: $('contactCompany').value.trim(),
    phone: $('contactPhone').value.trim(),
    notes: $('contactNotes').value.trim()
  });

  Store.set('contacts', contacts);
  $('contactName').value = '';
  $('contactCompany').value = '';
  $('contactPhone').value = '';
  $('contactNotes').value = '';
  renderContacts();
});

window.deleteContact = function(idx) {
  contacts.splice(idx, 1);
  Store.set('contacts', contacts);
  renderContacts();
};

// â”€â”€â”€ P&L Dashboard â”€â”€â”€
let pnlPeriod = 'daily';

document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    pnlPeriod = btn.dataset.period;
    updatePnlPage();
  });
});

function getPeriodStart() {
  const now = new Date();
  if (pnlPeriod === 'daily') {
    return new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
  } else if (pnlPeriod === 'weekly') {
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(now.getFullYear(), now.getMonth(), diff).toISOString();
  } else {
    return new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  }
}

function updatePnlPage() {
  const start = getPeriodStart();
  const periodTx = transactions.filter(t => t.date >= start);

  const buys = periodTx.filter(t => t.type === 'buy');
  const sells = periodTx.filter(t => t.type === 'sell');
  const wholesale = periodTx.filter(t => t.type === 'wholesale');

  const totalBought = buys.reduce((s, t) => s + t.total, 0);
  const totalSold = sells.reduce((s, t) => s + t.total, 0);
  const totalWholesale = wholesale.reduce((s, t) => s + t.total, 0);
  const totalProfit = periodTx.reduce((s, t) => s + t.profit, 0);

  $('pnlBought').textContent = fmt(totalBought);
  $('pnlBoughtCount').textContent = buys.length + ' transactions';
  $('pnlSold').textContent = fmt(totalSold + totalWholesale);
  $('pnlSoldCount').textContent = (sells.length + wholesale.length) + ' transactions';
  $('pnlProfit').textContent = (totalProfit >= 0 ? '+' : '-') + fmt(totalProfit);

  const revenue = totalSold + totalWholesale;
  const marginPct = revenue > 0 ? (totalProfit / revenue * 100).toFixed(1) : 0;
  $('pnlMarginPct').textContent = marginPct + '% margin';

  const { totalGold, totalSilver } = getInventory();
  $('pnlGold').textContent = fmtOz(totalGold) + ' oz';
  $('pnlGoldVal').textContent = fmt(totalGold * spotPrices.gold) + ' at spot';
  $('pnlSilver').textContent = fmtOz(totalSilver) + ' oz';
  $('pnlSilverVal').textContent = fmt(totalSilver * spotPrices.silver) + ' at spot';

  $('pnlWholesale').textContent = fmt(totalWholesale);
  $('pnlWholesaleCount').textContent = wholesale.length + ' transactions';

  // Capital position
  // Cash/wire in = sells + wholesale (money coming in)
  // Cash/wire out = buys (money going out)
  const cashIn = totalSold + totalWholesale;
  const cashOut = totalBought;
  const invValue = (totalGold * spotPrices.gold) + (totalSilver * spotPrices.silver);

  $('pnlCashIn').textContent = fmt(cashIn);
  $('pnlCashOut').textContent = fmt(cashOut);
  $('pnlInvValue').textContent = fmt(invValue);
  $('pnlCapital').textContent = fmt(cashIn - cashOut + invValue);
}

// â”€â”€â”€ Alerts â”€â”€â”€
function checkAlerts() {
  const { inv, totalGold, totalSilver } = getInventory();
  const alerts = [];

  if (totalGold > settings.threshGold) {
    alerts.push(`Gold inventory (${fmtOz(totalGold)} oz) exceeds ${fmtOz(settings.threshGold)} oz threshold`);
  }
  if (totalSilver > settings.threshSilver) {
    alerts.push(`Silver inventory (${fmtOz(totalSilver)} oz) exceeds ${fmtOz(settings.threshSilver)} oz threshold`);
  }

  // Per-form low-stock reorder alerts
  const rp = settings.reorderPoints || {};
  let lowStockCount = 0;
  const formKeys = ['coins', 'bars', 'rounds', 'junk', 'scrap'];
  ['gold', 'silver'].forEach(metal => {
    formKeys.forEach(form => {
      const key = metal + form.charAt(0).toUpperCase() + form.slice(1);
      const threshold = rp[key] || 0;
      if (threshold > 0 && inv[metal][form] < threshold) {
        lowStockCount++;
      }
    });
  });
  if (lowStockCount > 0) {
    alerts.push(`${lowStockCount} product(s) below reorder point`);
  }

  // Form 8300 compliance alerts
  const needsReviewCount = transactions.filter(t => t.form8300Flag && !t.form8300Reviewed).length;
  if (needsReviewCount > 0) {
    alerts.push(`${needsReviewCount} transaction(s) flagged for Form 8300 review`);
  }

  // 1099-B compliance alerts
  const needs1099BFiling = transactions.filter(t => t.form1099BFlag && !t.form1099BFiled).length;
  if (needs1099BFiling > 0) {
    alerts.push(`${needs1099BFiling} transaction(s) require 1099-B filing`);
  }

  // Retroactive 24-hour aggregation detection
  const cashTxByCustomer = {};
  transactions.forEach(t => {
    if (t.payment === 'cash' && t.customerId && t.total > 0) {
      if (!cashTxByCustomer[t.customerId]) cashTxByCustomer[t.customerId] = [];
      cashTxByCustomer[t.customerId].push(t);
    }
  });
  const unflaggedCustomers = [];
  Object.entries(cashTxByCustomer).forEach(([cid, txs]) => {
    for (let i = 0; i < txs.length; i++) {
      const refMs = new Date(txs[i].date).getTime();
      let windowTotal = 0;
      let hasUnflagged = false;
      for (let j = 0; j < txs.length; j++) {
        if (Math.abs(new Date(txs[j].date).getTime() - refMs) <= 86400000) {
          windowTotal += txs[j].total;
          if (!txs[j].form8300Flag) hasUnflagged = true;
        }
      }
      if (windowTotal >= 10000 && hasUnflagged) {
        const name = getCustomerName(cid);
        if (name && !unflaggedCustomers.includes(name)) unflaggedCustomers.push(name);
        break;
      }
    }
  });
  if (unflaggedCustomers.length > 0) {
    alerts.push(`${unflaggedCustomers.length} un-flagged 24-hour cash aggregation(s) detected for: ${unflaggedCustomers.join(', ')}`);
    $('bulkFlagBtn').style.display = '';
  } else {
    $('bulkFlagBtn').style.display = 'none';
  }

  // Retroactive 1099-B 24-hour aggregation detection
  const buyTxByCustomerProduct = {};
  transactions.forEach(t => {
    if (t.type === 'buy' && t.customerId && is1099BReportableProduct(t.metal, t.form, t.coinType)) {
      const groupKey = t.customerId + '|' + get1099BProductKey(t.metal, t.form, t.coinType);
      if (!buyTxByCustomerProduct[groupKey]) buyTxByCustomerProduct[groupKey] = [];
      buyTxByCustomerProduct[groupKey].push(t);
    }
  });
  const unflagged1099BCustomers = [];
  Object.entries(buyTxByCustomerProduct).forEach(([groupKey, txs]) => {
    const cid = groupKey.split('|')[0];
    const productKey = groupKey.split('|')[1];
    // Derive threshold from first tx in group
    const sampleTx = txs[0];
    const threshold = get1099BThreshold(sampleTx.metal, sampleTx.form, sampleTx.coinType);
    for (let i = 0; i < txs.length; i++) {
      const refMs = new Date(txs[i].date).getTime();
      let windowQty = 0;
      let hasUnflagged = false;
      for (let j = 0; j < txs.length; j++) {
        if (Math.abs(new Date(txs[j].date).getTime() - refMs) <= 86400000) {
          windowQty += txs[j].qty;
          if (!txs[j].form1099BFlag) hasUnflagged = true;
        }
      }
      if (windowQty >= threshold && hasUnflagged) {
        const name = getCustomerName(cid);
        if (name && !unflagged1099BCustomers.includes(name)) unflagged1099BCustomers.push(name);
        break;
      }
    }
  });
  if (unflagged1099BCustomers.length > 0) {
    alerts.push(`${unflagged1099BCustomers.length} un-flagged 1099-B aggregation(s) detected for: ${unflagged1099BCustomers.join(', ')}`);
  }

  const banner = $('alertBanner');
  if (alerts.length > 0) {
    $('alertText').textContent = alerts.join(' | ');
    banner.classList.add('visible');
  } else {
    banner.classList.remove('visible');
  }
}

$('bulkFlagBtn').addEventListener('click', () => {
  const cashTxByCustomer = {};
  transactions.forEach(t => {
    if (t.payment === 'cash' && t.customerId && t.total > 0) {
      if (!cashTxByCustomer[t.customerId]) cashTxByCustomer[t.customerId] = [];
      cashTxByCustomer[t.customerId].push(t);
    }
  });
  Object.values(cashTxByCustomer).forEach(txs => {
    for (let i = 0; i < txs.length; i++) {
      const refMs = new Date(txs[i].date).getTime();
      let windowTotal = 0;
      const windowTxs = [];
      for (let j = 0; j < txs.length; j++) {
        if (Math.abs(new Date(txs[j].date).getTime() - refMs) <= 86400000) {
          windowTotal += txs[j].total;
          windowTxs.push(txs[j]);
        }
      }
      if (windowTotal >= 10000) {
        windowTxs.forEach(t => { t.form8300Flag = true; });
      }
    }
  });
  Store.set('transactions', transactions);
  renderTransactions();
  checkAlerts();
});

// â”€â”€â”€ Settings â”€â”€â”€
function loadSettings() {
  $('settingShopName').value = settings.shopName;
  $('sellPremCoins').value = settings.sellPremCoins;
  $('sellPremBars').value = settings.sellPremBars;
  $('sellPremScrap').value = settings.sellPremScrap;
  $('buyDiscCoins').value = settings.buyDiscCoins;
  $('buyDiscBars').value = settings.buyDiscBars;
  $('buyDiscScrap').value = settings.buyDiscScrap;
  $('whDiscCoins').value = settings.whDiscCoins;
  $('whDiscBars').value = settings.whDiscBars;
  $('whDiscScrap').value = settings.whDiscScrap;
  const ca = settings.coinAdjustments || {};
  $('adjEagles').value = ca.eagles || 0;
  $('adjMaples').value = ca.maples || 0;
  $('adjKrugerrands').value = ca.krugerrands || 0;
  $('adjBritannias').value = ca.britannias || 0;
  $('adjPhilharmonics').value = ca.philharmonics || 0;
  $('adjPre33').value = ca.pre33 || 0;
  $('junkMultiplier').value = settings.junkMultiplier;
  $('junkMultOverride').value = settings.junkMultOverride || '';
  $('sellPremJunk').value = settings.sellPremJunk;
  $('buyDiscJunk').value = settings.buyDiscJunk;
  $('whDiscJunk').value = settings.whDiscJunk;
  $('threshGold').value = settings.threshGold;
  $('threshSilver').value = settings.threshSilver;
  const rp = settings.reorderPoints || {};
  $('reorderGoldCoins').value = rp.goldCoins || 0;
  $('reorderGoldBars').value = rp.goldBars || 0;
  $('reorderGoldRounds').value = rp.goldRounds || 0;
  $('reorderGoldScrap').value = rp.goldScrap || 0;
  $('reorderSilverCoins').value = rp.silverCoins || 0;
  $('reorderSilverBars').value = rp.silverBars || 0;
  $('reorderSilverRounds').value = rp.silverRounds || 0;
  $('reorderSilverJunk').value = rp.silverJunk || 0;
  $('reorderSilverScrap').value = rp.silverScrap || 0;
  $('shopNameDisplay').textContent = settings.shopName;
}

$('saveSettingsBtn').addEventListener('click', () => {
  settings = {
    shopName: $('settingShopName').value.trim() || 'My Bullion Shop',
    sellPremCoins: Math.max(0, parseFloat($('sellPremCoins').value) || 0),
    sellPremBars: Math.max(0, parseFloat($('sellPremBars').value) || 0),
    sellPremScrap: Math.max(0, parseFloat($('sellPremScrap').value) || 0),
    buyDiscCoins: Math.max(0, parseFloat($('buyDiscCoins').value) || 0),
    buyDiscBars: Math.max(0, parseFloat($('buyDiscBars').value) || 0),
    buyDiscScrap: Math.max(0, parseFloat($('buyDiscScrap').value) || 0),
    whDiscCoins: Math.max(0, parseFloat($('whDiscCoins').value) || 0),
    whDiscBars: Math.max(0, parseFloat($('whDiscBars').value) || 0),
    whDiscScrap: Math.max(0, parseFloat($('whDiscScrap').value) || 0),
    coinAdjustments: {
      eagles: Math.max(0, parseFloat($('adjEagles').value) || 0),
      maples: Math.max(0, parseFloat($('adjMaples').value) || 0),
      krugerrands: Math.max(0, parseFloat($('adjKrugerrands').value) || 0),
      britannias: Math.max(0, parseFloat($('adjBritannias').value) || 0),
      philharmonics: Math.max(0, parseFloat($('adjPhilharmonics').value) || 0),
      pre33: Math.max(0, parseFloat($('adjPre33').value) || 0)
    },
    junkMultiplier: parseFloat($('junkMultiplier').value) > 0 ? parseFloat($('junkMultiplier').value) : 0.715,
    junkMultOverride: parseFloat($('junkMultOverride').value) || null,
    sellPremJunk: Math.max(0, parseFloat($('sellPremJunk').value) || 0),
    buyDiscJunk: Math.max(0, parseFloat($('buyDiscJunk').value) || 0),
    whDiscJunk: Math.max(0, parseFloat($('whDiscJunk').value) || 0),
    threshGold: Math.max(0, parseFloat($('threshGold').value) || 10),
    threshSilver: Math.max(0, parseFloat($('threshSilver').value) || 500),
    reorderPoints: {
      goldCoins: Math.max(0, parseFloat($('reorderGoldCoins').value) || 0),
      goldBars: Math.max(0, parseFloat($('reorderGoldBars').value) || 0),
      goldRounds: Math.max(0, parseFloat($('reorderGoldRounds').value) || 0),
      goldScrap: Math.max(0, parseFloat($('reorderGoldScrap').value) || 0),
      silverCoins: Math.max(0, parseFloat($('reorderSilverCoins').value) || 0),
      silverBars: Math.max(0, parseFloat($('reorderSilverBars').value) || 0),
      silverRounds: Math.max(0, parseFloat($('reorderSilverRounds').value) || 0),
      silverJunk: Math.max(0, parseFloat($('reorderSilverJunk').value) || 0),
      silverScrap: Math.max(0, parseFloat($('reorderSilverScrap').value) || 0)
    }
  };

  Store.set('settings', settings);
  $('shopNameDisplay').textContent = settings.shopName;
  recalcDeal();
  checkAlerts();

  const confirm = $('saveConfirm');
  confirm.classList.add('show');
  setTimeout(() => confirm.classList.remove('show'), 2000);
});

// â”€â”€â”€ Data Export/Import â”€â”€â”€
$('exportDataBtn').addEventListener('click', () => {
  const data = {
    version: 1,
    exportedAt: new Date().toISOString(),
    settings,
    transactions,
    customers,
    contacts
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().slice(0, 10);
  a.href = url;
  a.download = `stacktrack-backup-${date}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

$('importDataBtn').addEventListener('click', () => {
  $('importFileInput').value = '';
  $('importFileInput').click();
});

$('importFileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const confirm = $('dataConfirm');
  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const data = JSON.parse(evt.target.result);
      if (!Array.isArray(data.transactions) || !Array.isArray(data.customers)) {
        throw new Error('Invalid backup file');
      }
      if (data.settings) { settings = { ...DEFAULT_SETTINGS, ...data.settings }; Store.set('settings', settings); }
      transactions = data.transactions; Store.set('transactions', transactions);
      customers = data.customers; Store.set('customers', customers);
      contacts = data.contacts || []; Store.set('contacts', contacts);
      loadSettings();
      renderTransactions();
      renderContacts();
      populateFilterCustomerSelect();
      checkAlerts();
      updateDashboard();
      confirm.textContent = 'Data imported!';
      confirm.style.color = 'var(--green)';
      confirm.classList.add('show');
      setTimeout(() => confirm.classList.remove('show'), 3000);
    } catch (err) {
      confirm.textContent = 'Import failed: ' + err.message;
      confirm.style.color = '#ef4444';
      confirm.classList.add('show');
      setTimeout(() => confirm.classList.remove('show'), 4000);
    }
  };
  reader.readAsText(file);
});

// â”€â”€â”€ Customer Selector â”€â”€â”€
const customerSearchInput = $('customerSearch');
const customerDropdown = $('customerDropdown');
const customerClearBtn = $('customerClearBtn');
const selectedCustomerIdInput = $('selectedCustomerId');

function selectCustomer(id) {
  const c = customers.find(c => c.id === id);
  if (!c) return;
  selectedCustomer = c;
  selectedCustomerIdInput.value = c.id;
  customerSearchInput.value = c.name;
  customerSearchInput.classList.add('has-selection');
  customerClearBtn.classList.add('visible');
  customerDropdown.classList.remove('open');
  recalcDeal();
}

function clearCustomer() {
  selectedCustomer = null;
  selectedCustomerIdInput.value = '';
  customerSearchInput.value = '';
  customerSearchInput.classList.remove('has-selection');
  customerClearBtn.classList.remove('visible');
  customerDropdown.classList.remove('open');
  recalcDeal();
}

customerSearchInput.addEventListener('input', () => {
  const query = customerSearchInput.value.trim().toLowerCase();
  if (selectedCustomer) {
    // User is typing over a selection, clear it
    selectedCustomer = null;
    selectedCustomerIdInput.value = '';
    customerSearchInput.classList.remove('has-selection');
    customerClearBtn.classList.remove('visible');
  }

  if (!query) {
    customerDropdown.classList.remove('open');
    return;
  }

  const matches = customers.filter(c =>
    c.name.toLowerCase().includes(query) ||
    (c.phone && c.phone.toLowerCase().includes(query))
  );

  let html = matches.map(c => {
    const details = [c.phone, c.notes].filter(Boolean).join(' Â· ');
    const w9Badge = c.w9OnFile ? '<span style="color:#4CAF50;font-size:10px;font-weight:700;margin-left:6px;">W-9 âœ“</span>' : '<span style="color:#FF9800;font-size:10px;font-weight:700;margin-left:6px;">No W-9</span>';
    return `<div class="customer-dropdown-item" data-id="${esc(c.id)}">
      <div class="customer-item-name">${esc(c.name)}${w9Badge}</div>
      ${details ? `<div class="customer-item-details">${esc(details)}</div>` : ''}
    </div>`;
  }).join('');

  html += `<div class="customer-dropdown-item add-new" data-action="add">+ Add "${esc(customerSearchInput.value.trim())}" as new customer</div>`;

  customerDropdown.innerHTML = html;
  customerDropdown.classList.add('open');
});

customerSearchInput.addEventListener('focus', () => {
  if (customerSearchInput.value.trim() && !selectedCustomer) {
    customerSearchInput.dispatchEvent(new Event('input'));
  }
});

customerDropdown.addEventListener('click', (e) => {
  const item = e.target.closest('.customer-dropdown-item');
  if (!item) return;

  if (item.dataset.action === 'add') {
    // Open add customer modal with name pre-filled
    $('newCustomerName').value = customerSearchInput.value.trim();
    $('newCustomerPhone').value = '';
    $('newCustomerNotes').value = '';
    $('addCustomerModal').classList.add('open');
    customerDropdown.classList.remove('open');
  } else if (item.dataset.id) {
    selectCustomer(item.dataset.id);
  }
});

customerClearBtn.addEventListener('click', clearCustomer);

// Close dropdown on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('.customer-selector-wrapper')) {
    customerDropdown.classList.remove('open');
  }
});

// â”€â”€â”€ Customers Page â”€â”€â”€
function renderCustomersPage() {
  const query = ($('customersSearchInput') ? $('customersSearchInput').value : '').toLowerCase().trim();
  const filtered = customers
    .filter(c => {
      if (!query) return true;
      return (c.name || '').toLowerCase().includes(query) ||
             (c.phone || '').toLowerCase().includes(query);
    })
    .sort((a, b) => (a.name || '').localeCompare(b.name || ''));

  const tbody = $('customersTableBody');
  const emptyEl = $('customersEmpty');
  const tableEl = $('customersTable');

  if (!tbody) return;

  if (filtered.length === 0) {
    tbody.innerHTML = '';
    tableEl.style.display = 'none';
    emptyEl.style.display = 'block';
  } else {
    tableEl.style.display = '';
    emptyEl.style.display = 'none';
    tbody.innerHTML = filtered.map(c => {
      const custTx = transactions.filter(t => t.customerId === c.id);
      const totalVolume = custTx.reduce((s, t) => s + t.total, 0);
      const flag8300 = custTx.filter(t => t.form8300Flag).length;
      const flag1099B = custTx.filter(t => t.form1099BFlag).length;
      const w9Class = c.w9OnFile ? 'on-file' : 'missing';
      const w9Label = c.w9OnFile ? 'On File' : 'Missing';
      return `<tr class="customer-row" data-customer-id="${esc(c.id)}">
        <td>${esc(c.name)}</td>
        <td>${esc(c.phone || 'â€”')}</td>
        <td><span class="w9-badge ${w9Class}">${w9Label}</span></td>
        <td>${custTx.length}</td>
        <td class="mono">${fmt(totalVolume)}</td>
        <td>${flag8300}</td>
        <td>${flag1099B}</td>
      </tr>`;
    }).join('');
  }
}

// Customer row click â†’ open profile
document.addEventListener('click', (e) => {
  const row = e.target.closest('.customer-row');
  if (row && row.dataset.customerId) {
    openCustomerProfile(row.dataset.customerId);
  }
});

// Customers page search
if ($('customersSearchInput')) {
  $('customersSearchInput').addEventListener('input', renderCustomersPage);
}

// Customers page add button â†’ open existing add customer modal
if ($('customersAddBtn')) {
  $('customersAddBtn').addEventListener('click', () => {
    const nameInput = $('newCustomerName');
    nameInput.value = '';
    nameInput.removeAttribute('readonly');
    $('newCustomerPhone').value = '';
    $('newCustomerNotes').value = '';
    $('newCustomerW9').checked = false;
    $('addCustomerModal').classList.add('open');
  });
}

// â”€â”€â”€ Add Customer Modal â”€â”€â”€
$('addCustomerCancelBtn').addEventListener('click', () => {
  $('addCustomerModal').classList.remove('open');
});

$('addCustomerSaveBtn').addEventListener('click', () => {
  const name = $('newCustomerName').value.trim();
  if (!name) return;

  const newCustomer = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    name,
    phone: $('newCustomerPhone').value.trim(),
    notes: $('newCustomerNotes').value.trim(),
    w9OnFile: $('newCustomerW9').checked
  };

  customers.push(newCustomer);
  Store.set('customers', customers);
  populateFilterCustomerSelect();
  renderCustomersPage();

  // Auto-select the new customer on the calculator
  selectCustomer(newCustomer.id);
  $('addCustomerModal').classList.remove('open');
});

// â”€â”€â”€ Dashboard â”€â”€â”€
function updateDashboard() {
  // Today's transactions (local date)
  const now = new Date();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
  const todayTx = transactions.filter(t => t.date >= todayStart);

  const todayBuys = todayTx.filter(t => t.type === 'buy');
  const todaySells = todayTx.filter(t => t.type === 'sell' || t.type === 'wholesale');
  const todayBought = todayBuys.reduce((s, t) => s + t.total, 0);
  const todaySold = todaySells.reduce((s, t) => s + t.total, 0);
  const todayProfit = todayTx.reduce((s, t) => s + t.profit, 0);

  $('dashTxCount').textContent = todayTx.length;
  $('dashBought').textContent = fmt(todayBought);
  $('dashSold').textContent = fmt(todaySold);
  $('dashProfit').textContent = (todayProfit >= 0 ? '+' : '-') + fmt(todayProfit);
  $('dashProfit').className = 'kpi-card-value ' + (todayProfit >= 0 ? 'green' : 'red');

  // Inventory snapshot
  const { inv, totalGold, totalSilver } = getInventory();
  const junkOz = (inv.silver.junk || 0);
  $('dashGoldOz').textContent = fmtOz(totalGold) + ' oz';
  $('dashGoldVal').textContent = fmt(totalGold * spotPrices.gold);
  $('dashSilverOz').textContent = fmtOz(totalSilver - junkOz) + ' oz';
  $('dashSilverVal').textContent = fmt((totalSilver - junkOz) * spotPrices.silver);
  $('dashJunkOz').textContent = fmtOz(junkOz) + ' oz';
  $('dashJunkVal').textContent = fmt(junkOz * spotPrices.silver);

  // Compliance action items
  const unfiled8300 = transactions.filter(t => t.form8300Flag && !t.form8300Reviewed).length;
  const unfiled1099B = transactions.filter(t => t.form1099BFlag && !t.form1099BFiled).length;
  const needW9 = customers.filter(c => !c.w9OnFile && transactions.some(t => t.customerId === c.id)).length;

  $('dashUnfiled8300').textContent = unfiled8300;
  $('dashUnfiled1099B').textContent = unfiled1099B;
  $('dashNeedW9').textContent = needW9;

  $('dashUnfiled8300').className = 'action-count ' + (unfiled8300 > 0 ? 'red' : 'green');
  $('dashUnfiled1099B').className = 'action-count ' + (unfiled1099B > 0 ? 'orange' : 'green');
  $('dashNeedW9').className = 'action-count ' + (needW9 > 0 ? 'orange' : 'green');

  // Recent transactions (last 10)
  const recent = [...transactions].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 10);
  const tbody = $('dashRecentBody');
  const empty = $('dashRecentEmpty');

  if (recent.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';
  tbody.innerHTML = recent.map(tx => {
    const d = new Date(tx.date);
    const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                    d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const typeClass = tx.type === 'buy' ? 'buy' : tx.type === 'sell' ? 'sell' : 'wholesale';
    const profitClass = tx.profit >= 0 ? 'profit-positive' : 'profit-negative';

    const lines = getTxLines(tx);
    const isMulti = lines.length > 1;
    let metalCol, qtyLabel;
    if (isMulti) {
      const metals = [...new Set(lines.map(l => l.metal))];
      metalCol = metals.map(m => m === 'gold' ? '<span style="color:var(--gold)">Au</span>' : '<span style="color:var(--silver)">Ag</span>').join('+');
      qtyLabel = lines.map(l => l.form === 'junk' ? '$' + fmtOz(l.qty) + ' FV' : isPre33(l.coinType) ? l.qty + ' coins' : l.form === 'scrap' && l.scrapPurity ? fmtOz(l.qty) + ' fine oz' : fmtOz(l.qty)).join(', ');
    } else {
      const line = lines[0];
      metalCol = line.metal === 'gold' ? '<span style="color:var(--gold)">Gold</span>' : '<span style="color:var(--silver)">Silver</span>';
      qtyLabel = line.form === 'junk' ? '$' + fmtOz(line.qty) + ' FV' : isPre33(line.coinType) ? line.qty + ' coins' : line.form === 'scrap' && line.scrapPurity ? fmtOz(line.qty) + ' fine oz' : line.weightUnit && line.weightUnit !== 'ozt' ? line.rawQty + (line.weightUnit === 'g' ? 'g' : ' ' + WEIGHT_UNITS[line.weightUnit].label) + ' (' + fmtOz(line.qty) + ' oz)' : fmtOz(line.qty) + ' oz';
    }

    const custName = getCustomerName(tx.customerId);
    const custCell = custName
      ? `<a href="#" onclick="openCustomerProfile('${esc(tx.customerId)}');return false;" style="color:var(--gold);text-decoration:none;">${esc(custName)}</a>`
      : 'â€”';

    return `<tr>
      <td class="mono">${dateStr}</td>
      <td>${metalCol}</td>
      <td><span class="type-badge ${typeClass}">${getTypeLabel(tx.type)}</span></td>
      <td>${custCell}</td>
      <td class="mono">${qtyLabel}</td>
      <td class="mono">${fmt(tx.total)}</td>
      <td class="${profitClass}">${(tx.profit >= 0 ? '+' : '-') + fmt(tx.profit)}</td>
    </tr>`;
  }).join('');
}

window.navigateToCompliance = function(filter) {
  // Navigate to transactions page with compliance filter
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const txNav = document.querySelector('.nav-item[data-page="transactions"]');
  if (txNav) txNav.classList.add('active');
  $('page-transactions').classList.add('active');

  if (filter === 'w9-needed') {
    // Can't filter by W-9 in transactions, just show all compliance
    $('filterCompliance').value = '';
  } else {
    $('filterCompliance').value = filter;
  }
  renderTransactions();
};

// â”€â”€â”€ Customer Profile â”€â”€â”€
window.openCustomerProfile = function(customerId) {
  const customer = customers.find(c => c.id === customerId);
  if (!customer) return;

  $('cpCustomerId').value = customerId;
  $('cpName').textContent = customer.name;
  $('cpEmail').value = customer.email || '';
  $('cpPhone').value = customer.phone || '';
  $('cpNotes').value = customer.notes || '';
  $('cpW9').checked = !!customer.w9OnFile;

  // Compute stats
  const custTx = transactions.filter(t => t.customerId === customerId);
  const buys = custTx.filter(t => t.type === 'buy');
  const sells = custTx.filter(t => t.type === 'sell' || t.type === 'wholesale');
  const totalBought = buys.reduce((s, t) => s + t.total, 0);
  const totalSold = sells.reduce((s, t) => s + t.total, 0);
  const netPnl = custTx.reduce((s, t) => s + t.profit, 0);

  $('cpTotalTx').textContent = custTx.length;
  $('cpTotalBought').textContent = fmt(totalBought);
  $('cpTotalSold').textContent = fmt(totalSold);
  $('cpNetPnl').textContent = (netPnl >= 0 ? '+' : '-') + fmt(netPnl);
  $('cpNetPnl').className = 'cp-stat-value ' + (netPnl >= 0 ? 'green' : 'red');

  // Compliance summary
  const flag8300 = custTx.filter(t => t.form8300Flag).length;
  const flag1099B = custTx.filter(t => t.form1099BFlag).length;
  let compHtml = '';
  compHtml += `<div class="cp-compliance-item ${flag8300 > 0 ? 'warn' : 'ok'}"><span class="count">${flag8300}</span> Form 8300 Flags</div>`;
  compHtml += `<div class="cp-compliance-item ${flag1099B > 0 ? 'info' : 'ok'}"><span class="count">${flag1099B}</span> 1099-B Flags</div>`;
  compHtml += `<div class="cp-compliance-item ${customer.w9OnFile ? 'ok' : 'info'}">${customer.w9OnFile ? 'W-9 On File' : 'No W-9'}</div>`;
  $('cpCompliance').innerHTML = compHtml;

  // Transaction history
  const sorted = [...custTx].sort((a, b) => b.date.localeCompare(a.date));
  const tbody = $('cpTxBody');

  if (sorted.length === 0) {
    tbody.innerHTML = '';
    $('cpTxEmpty').style.display = 'block';
  } else {
    $('cpTxEmpty').style.display = 'none';
    tbody.innerHTML = sorted.map(tx => {
      const d = new Date(tx.date);
      const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                      d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      const typeClass = tx.type === 'buy' ? 'buy' : tx.type === 'sell' ? 'sell' : 'wholesale';
      const profitClass = tx.profit >= 0 ? 'profit-positive' : 'profit-negative';

      const lines = getTxLines(tx);
      const isMulti = lines.length > 1;
      let metalCol, formCol, qtyLabel;
      if (isMulti) {
        const metals = [...new Set(lines.map(l => l.metal))];
        metalCol = metals.map(m => m === 'gold' ? '<span style="color:var(--gold)">Au</span>' : '<span style="color:var(--silver)">Ag</span>').join('+');
        formCol = lines.length + ' items';
        qtyLabel = lines.map(l => l.form === 'junk' ? '$' + fmtOz(l.qty) + ' FV' : isPre33(l.coinType) ? l.qty + ' coins' : fmtOz(l.qty)).join(', ');
      } else {
        const line = lines[0];
        metalCol = line.metal === 'gold' ? '<span style="color:var(--gold)">Gold</span>' : '<span style="color:var(--silver)">Silver</span>';
        formCol = getFormDisplayLabel(line.form, line.coinType);
        qtyLabel = line.form === 'junk' ? '$' + fmtOz(line.qty) + ' FV' : isPre33(line.coinType) ? line.qty + ' coins' : line.weightUnit && line.weightUnit !== 'ozt' ? line.rawQty + (line.weightUnit === 'g' ? 'g' : ' ' + WEIGHT_UNITS[line.weightUnit].label) + ' (' + fmtOz(line.qty) + ' oz)' : fmtOz(line.qty) + ' oz';
      }

      const badges = (tx.form8300Flag ? '<span class="compliance-badge">8300</span>' : '') +
                     (tx.form1099BFlag ? '<span class="compliance-badge-1099b">1099-B</span>' : '');
      return `<tr>
        <td class="mono">${dateStr}</td>
        <td>${metalCol}</td>
        <td>${formCol}</td>
        <td><span class="type-badge ${typeClass}">${getTypeLabel(tx.type)}</span></td>
        <td class="mono">${qtyLabel}</td>
        <td class="mono">${fmt(tx.total)}</td>
        <td class="${profitClass}">${(tx.profit >= 0 ? '+' : '-') + fmt(tx.profit)}</td>
        <td>${tx.payment === 'cash' ? 'Cash' : tx.payment === 'wire' ? 'Wire' : 'Check'}</td>
        <td>${badges || 'â€”'}</td>
      </tr>`;
    }).join('');
  }

  $('customerProfileOverlay').classList.add('open');
};

function saveCustomerProfile() {
  const id = $('cpCustomerId').value;
  const idx = customers.findIndex(c => c.id === id);
  if (idx === -1) return;

  customers[idx] = {
    ...customers[idx],
    email: $('cpEmail').value.trim() || undefined,
    phone: $('cpPhone').value.trim() || undefined,
    notes: $('cpNotes').value.trim() || undefined,
    w9OnFile: $('cpW9').checked
  };

  Store.set('customers', customers);
  populateFilterCustomerSelect();
  renderCustomersPage();

  // Refresh the profile view
  openCustomerProfile(id);
}

function closeCustomerProfile() {
  $('customerProfileOverlay').classList.remove('open');
}

function deleteCustomer() {
  if (!confirm('Delete this customer? This cannot be undone.')) return;
  const id = $('cpCustomerId').value;
  customers = customers.filter(c => c.id !== id);
  transactions.forEach(t => { if (t.customerId === id) t.customerId = null; });
  Store.set('customers', customers);
  Store.set('transactions', transactions);
  closeCustomerProfile();
  populateFilterCustomerSelect();
  renderCustomersPage();
  renderTransactions();
  updateDashboard();
}

$('cpDeleteBtn').addEventListener('click', deleteCustomer);
$('cpSaveBtn').addEventListener('click', saveCustomerProfile);
$('cpCloseBtn').addEventListener('click', closeCustomerProfile);
$('customerProfileOverlay').addEventListener('click', (e) => {
  if (e.target === $('customerProfileOverlay')) closeCustomerProfile();
});

// â”€â”€â”€ Init â”€â”€â”€
loadSettings();
renderContacts();
populateFilterCustomerSelect();
checkAlerts();
updateDashboard();
// Spot prices and calculator update after first API fetch completes
</script>
</body>
</html>
